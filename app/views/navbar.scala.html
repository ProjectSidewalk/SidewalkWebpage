@import models.user.User
@(user: Option[User] = None, url: Option[String] = Some("/"))

@import views.html.bootstrap._


<nav class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="@routes.ApplicationController.index">Project Sidewalk
                <sub>beta <sub>2</sub></sub></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                @if(url.isDefined && url.get != "/audit") {
                    <li>
                        <a href='@routes.ApplicationController.results'>View Results</a>
                    </li>
                } else {
                    <li>
                        <a href='@routes.ApplicationController.results' target="_blank">View Results</a>
                    </li>
                }

                @if(url.isDefined && url.get != "/audit") {
                    <li>
                        <a href="@routes.ApplicationController.faq()" target="_blank">FAQ</a>
                    </li>
                    <li>
                        <a href='@routes.AuditController.audit' class="bold">Start Auditing</a>
                    </li>
                } else {
                    <li>
                        <a href="@routes.ApplicationController.faq()" target="_blank">FAQ</a>
                    </li>
                    <li>
                        <a href="#" id="toolbar-onboarding-link">Retake tutorial</a>
                    </li>
                }

                <!--<li><a href="#">Explore Accessibility!</a></li>-->
                <li class="dropdown" id="navbar-dropdown-list">
                    @if(user) {
                        <a id="nav-user-dropdown" role="button" data-toggle="dropdown" href="#">
                            <img src='@routes.Assets.at("images/avatar.png")' alt="User avatar" class="avatar-medium">&nbsp;
                            @user.get.username
                            <b class="caret"></b>
                        </a>
                        <ul id="nav-user-menu" class="dropdown-menu" role="menu" aria-labelledby="User menu">
                            <li role="presentation">
                                <a href='@routes.UserProfileController.userProfile(user.get.username)' role="menuitem">
                                    Your dashboard
                                </a>
                            </li>
                            @if(user.get.roles.getOrElse(Seq("")).contains("Administrator")) {
                                <li role="presentation">
                                    <a href='@routes.AdminController.index' role="menuitem">
                                        Admin
                                    </a>
                                </li>
                            }
                            <li role="presentation">
                                <a href='@routes.UserController.signOut(url.getOrElse("/"))' role="menuitem">Sign out</a>
                            </li>
                        </ul>
                    } else {
                        <a href="#SignIn" data-toggle="modal" data-target="#sign-in-modal-container">
                            <img src='@routes.Assets.at("images/avatar.png")' alt="User avatar" class="avatar-medium">
                                &nbsp;Sign in
                        </a>
                    }
                </li>
            </ul>
        </div>
    </div>
</nav>
@if(!user) {
    <script type="text/javascript">
        $(document).ready(function () {
            $("#form-open-sign-up").on("mouseup", function () {
                $("#sign-in-modal").addClass("hidden");
                $("#sign-up-modal").removeClass("hidden");
            });

            $("#form-open-sign-in").on("mouseup", function () {
                $("#sign-up-modal").addClass("hidden");
                $("#sign-in-modal").removeClass("hidden");
            });
        });
    </script>
    <div class="modal fade" id="sign-in-modal-container" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="sign-in-modal">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="sign-in-label">Sign in</h4>
                </div>
                <div class="modal-body">
                    @helper.form(action = routes.CredentialsAuthController.authenticate(url.getOrElse("/")), args = 'id -> "sign-in-form") {
                    @text(forms.SignInForm.form("identifier"), "Email address")
                    @password(forms.SignInForm.form("password"), "Password")
                    <button id="sign-in-submit" type="submit" value="submit" class="btn btn-sm btn-primary btn-block">Sign in</button>
                    }
                </div>
                <div class="modal-footer">
                    <div>
                        Are you new? <a href="#" id="form-open-sign-up">Sign up!</a>
                    </div>
                </div>
            </div><!-- /.modal-content -->
            <div class="modal-content hidden" id="sign-up-modal">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="sign-up-label">Sign up</h4>
                </div>
                <div class="modal-body">
                    @helper.form(action = routes.SignUpController.signUp(url.getOrElse("/")), args ='id -> "sign-up-form") {
                    @text(forms.SignUpForm.form("username"), "Username", icon = "person")
                    @text(forms.SignUpForm.form("email"), "Email", icon = "at")
                    @password(forms.SignUpForm.form("password"), "Password", icon = "key")
                    <div class="form-group">
                        <div class="checkbox">
                            <label><input type="checkbox" id="navbar-agree-to-terms">You agree to our <a target="_blank" href="@routes.ApplicationController.terms">Terms of Use and Privacy Policy</a></label>
                        </div>
                        <div>
                            <button id="sign-up-submit" type="submit" value="submit" class="btn btn-primary btn-block" disabled>Sign up</button>
                        </div>
                    </div>
                    }
                </div>
                <div class="modal-footer">
                    <div>
                        Have an account? <a href="#" id="form-open-sign-in">Sign in!</a>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <script>
            $(document).ready(function() {
                $("#navbar-agree-to-terms").click(function() {
                    if ($(this).prop("checked")) {
                        $("#sign-up-submit").prop("disabled", false);
                    } else {
                        $("#sign-up-submit").prop("disabled", true);
                    }
                });
            });

            // Callback function for sign in success
            function signInSuccess(data) {
                var htmlString = $("#navbar-dropdown-list-signed-in").html();
                htmlString = htmlString.replace(/__USERNAME__/g, data.username);

                $("#navbar-dropdown-list").html(htmlString);

                // Append the link to the admin interface if it the user is admin
                if (data.roles && data.roles.indexOf("Administrator") >= 0) {
                    var adminLi = '<li role="presentation"><a href="/admin" role="menuitem">Admin</a></li>';
                    $("#nav-user-menu").append(adminLi);
                }

                $('#sign-in-modal-container').modal('toggle');
            }

            // Intercept form-based sign in and use AJAX to signin so the page does not refresh.
            $('#sign-in-form').submit(function () {
                var data = $(this).serialize();
                var url = '/authapi/authenticate';
                $.post(url, data, signInSuccess);
                return false;
            });

            $('#sign-up-form').submit(function () {
                var data = $(this).serialize();
                var url = '/authapi/signup';
                $.post(url, data, signInSuccess);
                return false;
            });
    </script>
    <template id="navbar-dropdown-list-signed-in">
        <a id="nav-user-dropdown" role="button" data-toggle="dropdown" href="#">
            <img src='@routes.Assets.at("images/avatar.png")' alt="User avatar" class="avatar-medium">&nbsp;
            __USERNAME__
            <b class="caret"></b>
        </a>
        <ul id="nav-user-menu" class="dropdown-menu" role="menu" aria-labelledby="User menu">
            <li role="presentation">
                <a href='/contribution/__USERNAME__' role="menuitem">
                    Your dashboard
                </a>
            </li>
            <li role="presentation">
                <a href='@routes.UserController.signOut(url.getOrElse("/"))' role="menuitem">Sign out</a>
            </li>
        </ul>
    </template>
    <template id="navbar-dropdown-list-signed-out">
        <a href="#SignIn" data-toggle="modal" data-target="#sign-in-modal-container">
            <img src='@routes.Assets.at("images/avatar.png")' alt="User avatar" class="avatar-medium">&nbsp;
            Sign in
        </a>
    </template>
}