@* Assumes activePage is passed correctly to identify this page in the sidebar *@
@(activePage: String = "user-stats")(implicit request: RequestHeader, assets: AssetsFinder, cityName: String)

@content = {
<div class="api-section" id="user-stats-intro-section">
  <h1 class="api-heading" id="user-stats-api">User Stats API <a href="#user-stats-api" class="permalink">#</a></h1>
  <p>
    The User Stats API provides comprehensive statistics about Project Sidewalk users and their contributions
    in <strong>@cityName</strong>, including labels placed, distance explored, and validation activities. 
    Each user is identified by an anonymized ID, which persists over time.
  </p>
</div>

<div class="api-section" id="user-stats-preview-section">
  <h2 class="api-heading" id="visual-example">User Stats API Preview <a href="#visual-example" class="permalink">#</a></h2>
  <p>Below is a live preview of user statistics in <strong>@cityName</strong> retrieved directly from the API, showing the distribution of
    user contributions and label accuracy across the Project Sidewalk community.</p>
  
  <div id="user-stats-preview">Loading user stats data...</div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@@3.9.1/dist/chart.min.js"></script>
  <link rel="stylesheet" href="@assets.path("stylesheets/api-docs/user-stats.css")">
  <script src="@routes.Assets.versioned("javascripts/api-docs/user-stats-preview.js")"></script>
  <script>
    // Initialize the user stats preview visualization
    document.addEventListener('DOMContentLoaded', function() {
      UserStatsPreview.setup({
        containerHeight: 500,
        apiBaseUrl: document.documentElement.getAttribute('data-api-base-url') || 'http://localhost:9000/v3/api',
        cityName: '@cityName'
      }).init();
    });
  </script>
</div>

<div class="api-section" id="endpoint-section">
  <h2 class="api-heading" id="endpoint">Endpoint <a href="#endpoint" class="permalink">#</a></h2> 
  <p>Retrieve statistics for all registered users or filter based on specific criteria.</p>
  <p><code>GET /v3/api/userStats</code></p>
  <p><strong>Base URL:</strong> <code>https://api.projectsidewalk.org/v3</code></p>
</div>

<script>
  console.log('Setting data attributes for API information');
  document.documentElement.setAttribute('data-api-base-url', 'http://localhost:9000/v3/api');
  document.documentElement.setAttribute('data-api-endpoint', 'userStats');
  console.log('Data attributes set:', {
    'data-api-base-url': document.documentElement.getAttribute('data-api-base-url'),
    'data-api-endpoint': document.documentElement.getAttribute('data-api-endpoint')
  });
</script>

<div class="api-section" id="quick-download-section">
  <h2 class="api-heading" id="quick-download">Quick Download <a href="#quick-download" class="permalink">#</a></h2>
  <p>
    Download user statistics data directly in your preferred format:
  </p>
  
  <div class="download-buttons">
    <button class="download-btn" data-format="json">
      <span class="format-icon">ðŸ“„</span> JSON
      <span class="format-hint">Standard format</span>
    </button>
    <button class="download-btn" data-format="csv">
      <span class="format-icon">ðŸ“Š</span> CSV
      <span class="format-hint">For Excel, Google Sheets</span>
    </button>
  </div>
  
  <div id="download-status" class="download-status" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="status-message">Preparing your download...</div>
    <div class="status-progress">This should only take a few seconds.</div>
  </div>
</div>

<div class="api-section" id="query-parameters-section">
  <h2 class="api-heading" id="query-parameters">Query Parameters<a href="#query-parameters" class="permalink">#</a></h2> 
  <p>
    This endpoint accepts the following optional query parameters to filter results and customize the response format.
  </p>

  <div class="api-table-wrapper">
    <table class="api-table">
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>filetype</code></td>
          <td><code>string</code></td>
          <td>Specify the output format. Options: <code>json</code> (default), <code>csv</code>.</td>
        </tr>
        <tr>
          <td><code>min_labels</code></td>
          <td><code>integer</code></td>
          <td>Filter users with at least this many total labels. Default: 0 (no minimum).</td>
        </tr>
        <tr>
          <td><code>max_labels</code></td>
          <td><code>integer</code></td>
          <td>Filter users with at most this many total labels.</td>
        </tr>
        <tr>
          <td><code>min_meters</code></td>
          <td><code>number</code></td>
          <td>Filter users who have explored at least this many meters. Default: 0 (no minimum).</td>
        </tr>
        <tr>
          <td><code>max_meters</code></td>
          <td><code>number</code></td>
          <td>Filter users who have explored at most this many meters.</td>
        </tr>
        <tr>
          <td><code>min_accuracy</code></td>
          <td><code>number</code></td>
          <td>Filter users with at least this label accuracy (0.0-1.0). Users without validation data will be excluded.</td>
        </tr>
        <tr>
          <td><code>high_quality_only</code></td>
          <td><code>boolean</code></td>
          <td>When set to <code>true</code>, only include users flagged as high quality contributors. Default: <code>false</code>.</td>
        </tr>
        <tr>
          <td><code>min_validations_given</code></td>
          <td><code>integer</code></td>
          <td>Filter users who have performed at least this many validations.</td>
        </tr>
        <tr>
          <td><code>has_label_type</code></td>
          <td><code>string</code></td>
          <td>Filter users who have placed at least one label of a specific type. Provide comma-separated values for multiple types (e.g., <code>has_label_type=curb_ramp,crosswalk</code>). Label type names are case-sensitive and should be provided in snake_case format.</td>
        </tr>
        <tr>
          <td><code>sort_by</code></td>
          <td><code>string</code></td>
          <td>Sort the results by a specific field. Options: <code>labels</code> (default), <code>meters_explored</code>, <code>label_accuracy</code>, <code>validations_given</code>.</td>
        </tr>
        <tr>
          <td><code>sort_order</code></td>
          <td><code>string</code></td>
          <td>Sort order. Options: <code>desc</code> (default), <code>asc</code>.</td>
        </tr>
        <tr>
          <td><code>limit</code></td>
          <td><code>integer</code></td>
          <td>Maximum number of users to return. Default: 1000.</td>
        </tr>
        <tr>
          <td><code>offset</code></td>
          <td><code>integer</code></td>
          <td>Number of users to skip (for pagination). Default: 0.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="api-section" id="example-requests-section">
  <h3 class="api-heading" id="example-requests">Example Requests <a href="#example-requests" class="permalink">#</a></h3> 

  <h4 class="api-heading" id="basic-example">Basic Examples <a href="#basic-example" class="permalink">#</a></h4> 
  <p>Request statistics for all users in CSV format:</p>
  <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v3/api/userStats?filetype=csv"
  </code></pre>

  <p>Request statistics for high-quality users who have placed at least 100 labels and explored at least 1000 meters:</p>
  <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v3/api/userStats?min_labels=100&min_meters=1000&high_quality_only=true"
  </code></pre>

  <h4 class="api-heading" id="advanced-filtering">Advanced Filtering <a href="#advanced-filtering" class="permalink">#</a></h4>
  <p>Request the top 10 users by accuracy who have at least 50 validated labels and have placed both curb ramp and crosswalk labels:</p>
  <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v3/api/userStats?min_labels=50&has_label_type=curb_ramp,crosswalk&sort_by=label_accuracy&limit=10"
  </code></pre>

  <p>Find users who focus primarily on validation rather than labeling (more validations given than labels placed):</p>
  <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v3/api/userStats?min_validations_given=100&sort_by=validations_given&sort_order=desc"
  </code></pre>

  <h4 class="api-heading" id="pagination-example">Pagination Example <a href="#pagination-example" class="permalink">#</a></h4>
  <p>Request statistics for users in batches of 100, getting the second page of results:</p>
  <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v3/api/userStats?limit=100&offset=100"
  </code></pre>

  <h4 class="api-heading" id="python-example">Python Data Analysis Example <a href="#python-example" class="permalink">#</a></h4> 
  <p>Fetch user statistics and analyze the relationship between exploration distance and label accuracy:</p>
  <pre><code class="language-python">
import requests
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

BASE_URL = "https://api.projectsidewalk.org/v3/api"

# Get user stats data for users with enough validation data
response = requests.get(
    f"{BASE_URL}/userStats", 
    params={
        "min_labels": 50,
        "min_validations_given": 20
    }
)
data = response.json()

# Convert to DataFrame
df = pd.DataFrame(data)

# Filter out users without accuracy data
df = df[df['label_accuracy'].notna()]

# Explore the relationship between exploration distance and accuracy
(figsize=(12, 8))
plt.scatter(df['meters_explored'], df['label_accuracy'], 
            s=df['labels']/10, alpha=0.6, c=df['validations_given'], cmap='viridis')
plt.colorbar(label='Validations Given')
plt.xscale('log')
plt.xlabel('Meters Explored (log scale)')
plt.ylabel('Label Accuracy')
plt.title('Relationship Between Exploration Distance, Label Volume, and Accuracy')
plt.grid(True, alpha=0.3)

# Analyze label type distributions for the top 20 contributors
top_users = df.sort_values('labels', ascending=False).head(20)

# Extract label types from stats_by_label_type
label_type_data = {}
for user_id in top_users['user_id']:
    user_data = next(u for u in data if u['user_id'] == user_id)
    for label_type, stats in user_data['stats_by_label_type'].items():
        if label_type not in label_type_data:
            label_type_data[label_type] = []
        label_type_data[label_type].append(stats['labels'])

# Create a DataFrame for label type distribution
label_df = pd.DataFrame(label_type_data, index=top_users['user_id'])

# Plot the distribution of label types
plt.figure(figsize=(14, 8))
label_df.plot(kind='bar', stacked=True, ax=plt.gca())
plt.title('Distribution of Label Types Among Top 20 Contributors')
plt.xlabel('User ID')
plt.ylabel('Number of Labels')
plt.xticks(rotation=45)
plt.legend(title='Label Type')
plt.tight_layout()
plt.show()

# Calculate and print summary statistics
print("Summary Statistics:")
print(f"Total Users: {len(df)}")
print(f"Total Labels: {df['labels'].sum()}")
print(f"Total Distance Explored: {df['meters_explored'].sum()/1000:.2f} km")
print(f"Average Label Accuracy: {df['label_accuracy'].mean():.2%}")
print(f"Average Labels per User: {df['labels'].mean():.1f}")
  </code></pre>
</div>

<div class="api-section" id="responses-section">
  <h2 class="api-heading" id="responses">Responses<a href="#responses" class="permalink">#</a></h2> 

  <h3 class="api-heading" id="success-response-200-ok">Success Response (200 OK)<a href="#success-response-200-ok" class="permalink">#</a></h3> 
  <p>
    On success, the API returns an HTTP <code>200 OK</code> status code and the requested data in the specified <code>filetype</code> format.
  </p>
  
  <h4 id="response-json">JSON Format (Default) <a href="#response-json" class="permalink">#</a></h4>
  <p>Returns an array of user statistics objects, each representing a single user's contribution data:</p>
  <pre><code class="language-json">
[
  {
    "user_id": "bfab6670-0955-440c-abe8-01c2d20696ba",
    "labels": 27,
    "meters_explored": 154.8437957763672,
    "labels_per_meter": 0.17436927556991577,
    "high_quality": true,
    "high_quality_manual": null,
    "label_accuracy": 0.9545454382896423,
    "validated_labels": 22,
    "validations_received": 22,
    "labels_validated_correct": 21,
    "labels_validated_incorrect": 1,
    "labels_not_validated": 5,
    "validations_given": 20,
    "dissenting_validations_given": 5,
    "agree_validations_given": 14,
    "disagree_validations_given": 6,
    "unsure_validations_given": 0,
    "stats_by_label_type": {
      "curb_ramp": {
        "labels": 16,
        "validated_correct": 15,
        "validated_incorrect": 1,
        "not_validated": 0
      },
      "no_curb_ramp": {
        "labels": 0,
        "validated_correct": 0,
        "validated_incorrect": 0,
        "not_validated": 0
      },
      // ... other label types
    }
  },
  // ... more user statistics objects
]
  </code></pre>

  <h5 id="json-fields">JSON Field Descriptions <a href="#json-fields" class="permalink">#</a></h5>
  <p>Each user statistics object contains the following fields:</p>
  
  <div class="api-table-wrapper">
    <table class="api-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr><td><code>user_id</code></td><td><code>string</code></td><td>Anonymized unique identifier for the user.</td></tr>
        <tr><td><code>labels</code></td><td><code>integer</code></td><td>Total number of labels placed by the user.</td></tr>
        <tr><td><code>meters_explored</code></td><td><code>number</code></td><td>Total distance explored by the user in meters.</td></tr>
        <tr><td><code>labels_per_meter</code></td><td><code>number | null</code></td><td>Average number of labels placed per meter explored, or null if no distance explored.</td></tr>
        <tr><td><code>high_quality</code></td><td><code>boolean</code></td><td>Whether the user is flagged as a high-quality contributor based on algorithmic assessment.</td></tr>
        <tr><td><code>high_quality_manual</code></td><td><code>boolean | null</code></td><td>Manual override of high-quality status by administrators, or null if not set.</td></tr>
        <tr><td><code>label_accuracy</code></td><td><code>number | null</code></td><td>Accuracy of the user's labels based on validations, ranging from 0.0 to 1.0, or null if no validations.</td></tr>
        <tr><td><code>validated_labels</code></td><td><code>integer</code></td><td>Number of the user's labels that have been validated by others.</td></tr>
        <tr><td><code>validations_received</code></td><td><code>integer</code></td><td>Total number of validations received on the user's own labels.</td></tr>
        <tr><td><code>labels_validated_correct</code></td><td><code>integer</code></td><td>Number of the user's labels validated as correct.</td></tr>
        <tr><td><code>labels_validated_incorrect</code></td><td><code>integer</code></td><td>Number of the user's labels validated as incorrect.</td></tr>
        <tr><td><code>labels_not_validated</code></td><td><code>integer</code></td><td>Number of the user's labels that have not been validated.</td></tr>
        <tr><td><code>validations_given</code></td><td><code>integer</code></td><td>Total number of validations performed by the user on others' labels.</td></tr>
        <tr><td><code>dissenting_validations_given</code></td><td><code>integer</code></td><td>Number of validations where the user disagreed with the majority.</td></tr>
        <tr><td><code>agree_validations_given</code></td><td><code>integer</code></td><td>Number of validations where the user agreed with the label.</td></tr>
        <tr><td><code>disagree_validations_given</code></td><td><code>integer</code></td><td>Number of validations where the user disagreed with the label.</td></tr>
        <tr><td><code>unsure_validations_given</code></td><td><code>integer</code></td><td>Number of validations where the user was unsure about the label.</td></tr>
        <tr><td><code>stats_by_label_type</code></td><td><code>object</code></td><td>Breakdown of statistics by label type.</td></tr>
      </tbody>
    </table>
  </div>
  
  <h5 id="label-type-stats">Label Type Statistics Fields <a href="#label-type-stats" class="permalink">#</a></h5>
  <p>The <code>stats_by_label_type</code> object contains a key for each label type, with values that provide detailed statistics for that specific type of label:</p>
  
  <div class="api-table-wrapper">
    <table class="api-table">
      <thead>
        <tr>
          <th>Field</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr><td><code>stats_by_label_type.[type]</code></td><td><code>object</code></td><td>Statistics for a specific label type (e.g., "curb_ramp", "obstacle"). The available label types match those in the <a href="@routes.ApiDocsController.labelTypes()">Label Types API</a>, but are provided in snake_case format.</td></tr>
        <tr><td><code>stats_by_label_type.[type].labels</code></td><td><code>integer</code></td><td>Number of labels of this type placed by the user.</td></tr>
        <tr><td><code>stats_by_label_type.[type].validated_correct</code></td><td><code>integer</code></td><td>Number of this type of label validated as correct.</td></tr>
        <tr><td><code>stats_by_label_type.[type].validated_incorrect</code></td><td><code>integer</code></td><td>Number of this type of label validated as incorrect.</td></tr>
        <tr><td><code>stats_by_label_type.[type].not_validated</code></td><td><code>integer</code></td><td>Number of this type of label not yet validated.</td></tr>
      </tbody>
    </table>
  </div>

  <h4 id="response-csv">CSV Format <a href="#response-csv" class="permalink">#</a></h4>
  <p>If <code>filetype=csv</code> is specified, the response body will be CSV data. The first row contains the header fields, with the <code>stats_by_label_type</code> object flattened into individual columns for each label type and statistic.</p>
  <pre><code class="language-csv">
user_id,labels,meters_explored,labels_per_meter,high_quality,high_quality_manual,label_accuracy,validated_labels,validations_received,labels_validated_correct,labels_validated_incorrect,labels_not_validated,validations_given,dissenting_validations_given,agree_validations_given,disagree_validations_given,unsure_validations_given,curb_ramp_labels,curb_ramp_validated_correct,curb_ramp_validated_incorrect,curb_ramp_not_validated,no_curb_ramp_labels,no_curb_ramp_validated_correct,no_curb_ramp_validated_incorrect,no_curb_ramp_not_validated,...
"bfab6670-0955-440c-abe8-01c2d20696ba",27,154.8437957763672,0.17436927556991577,true,,0.9545454382896423,22,22,21,1,5,20,5,14,6,0,16,15,1,0,0,0,0,0,...
"814f4169-98a1-4afa-80da-3b46be1da405",687,9898.09765625,0.06940727680921555,true,,0.8013029098510742,614,2106,492,122,73,60,7,35,7,18,519,414,61,44,64,10,51,3,...
...
  </code></pre>
  
  <h5 id="csv-fields">CSV Column Descriptions <a href="#csv-fields" class="permalink">#</a></h5>
  <p>In CSV format, each row corresponds to a user, and the columns map to the JSON fields as follows:</p>
  <ul>
    <li>The first set of columns match the top-level attributes from the JSON format (e.g., <code>user_id</code>, <code>labels</code>, <code>meters_explored</code>, etc.)</li>
    <li>The label type statistics are flattened into a set of columns for each label type, with the naming pattern <code>[label_type]_[statistic]</code></li>
    <li>For example, <code>curb_ramp_labels</code>, <code>curb_ramp_validated_correct</code>, <code>curb_ramp_validated_incorrect</code>, <code>curb_ramp_not_validated</code>, etc.</li>
    <li>This flattened structure makes it easier to import the data into spreadsheet applications and data analysis tools</li>
  </ul>

  <h3 class="api-heading" id="error-responses">Error Responses<a href="#error-responses" class="permalink">#</a></h3> 
  <p>If an error occurs, the API will return an appropriate HTTP status code and a JSON response body containing details about the error.</p>
  <ul>
    <li><strong><code>400 Bad Request</code>:</strong> Invalid parameter values.</li>
    <li><strong><code>404 Not Found</code>:</strong> The requested resource does not exist.</li>
    <li><strong><code>500 Internal Server Error</code>:</strong> An unexpected error occurred on the server.</li>
    <li><strong><code>503 Service Unavailable</code>:</strong> The server is temporarily unable to handle the request.</li>
  </ul>

  <h4 id="error-body">Error Response Body <a href="#error-body" class="permalink">#</a></h4>
  <p>Error responses include a JSON body with the following structure:</p>
  <pre><code class="language-json">
{
  "status": 400, // HTTP Status Code
  "code": "INVALID_PARAMETER", // Machine-readable error code
  "message": "Invalid value for min_labels parameter. Expected a positive integer.", // Human-readable description
  "parameter": "min_labels" // Optional: The specific parameter causing the error
}
  </code></pre>
</div>

<div class="api-section" id="best-practices-section">
  <h2 class="api-heading" id="data-analysis-tips">Data Analysis Tips <a href="#data-analysis-tips" class="permalink">#</a></h2>
  <p>
    The User Stats API provides rich data for analysis. Here are some tips for meaningful analysis:
  </p>
  <ul>
    <li><strong>Consider using minimum thresholds</strong> for label count and validated labels to ensure sufficient data for meaningful analysis</li>
    <li><strong>Look beyond just quantity</strong> - high label counts don't always equate to high-quality data</li>
    <li><strong>Analyze the relationship</strong> between labels per meter and accuracy to understand contribution thoroughness</li>
    <li><strong>Compare validation patterns</strong> across different types of labels to identify where quality issues might exist</li>
    <li><strong>Use the Label Types API</strong> to get proper color coding and descriptions for visualizations</li>
  </ul>
  
  <div class="api-callout">
    <h3><i class="icon icon-code"></i> Related APIs</h3>
    <p>
      For more comprehensive analysis, consider using the User Stats API in conjunction with:
    </p>
    <ul>
      <li><a href="@routes.ApiDocsController.labelTypes()">Label Types API</a> - Get information about the different types of accessibility issues</li>
      <li><a href="@routes.ApiDocsController.rawLabels()">Raw Labels API</a> - Access individual label data with geographic information and user ids</li>
      <li><a href="TODO">Label Clusters API</a> - Work with clustered label data</li>
    </ul>
  </div>
</div>
</content>
}

@* Use the main layout template, passing the active page identifier and the content block *@
@apiDocs.layout(activePage)(content)