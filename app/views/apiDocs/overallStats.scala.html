@import service.CommonPageData
@import models.user.SidewalkUserWithRole
@import play.api.Configuration
@(commonData: CommonPageData, user: SidewalkUserWithRole)(implicit request: RequestHeader, messages: Messages, assets: AssetsFinder, config: Configuration)
@cityName = @{commonData.allCityInfo.filter(c => c.cityId == commonData.cityId).head.cityNameFormatted}

@content = {
    <script>
        // Set data attributes for API information. This is used by our JavaScripts to configure API calls,
        // including the download buttons in api-docs.js
        console.log('Setting data attributes for API information');
        document.documentElement.setAttribute('data-api-base-url', '/v3/api');
        document.documentElement.setAttribute('data-api-endpoint', 'overallStats');
        console.log('Data attributes set:', {
            'data-api-base-url': document.documentElement.getAttribute('data-api-base-url'),
            'data-api-endpoint': document.documentElement.getAttribute('data-api-endpoint')
        });
    </script>

    <div class="api-section" id="overall-stats-intro-section">
        <h1 class="api-heading" id="overall-stats-api">Overall Stats API <a href="#overall-stats-api" class="permalink">#</a></h1>
        <p>
            The Overall Stats API provides project-wide statistics about Project Sidewalk's data collection efforts in
            <strong>@cityName</strong>, including total distance covered, label counts by type, user participation
            metrics, and data quality indicators.
        </p>
    </div>

    <div class="api-section" id="overall-stats-preview-section">
        <h2 class="api-heading" id="visual-example">Overall Stats API Preview <a href="#visual-example" class="permalink">#</a></h2>
        <p>Below is a live preview of the Overall Stats API data for <strong>@cityName</strong>:</p>

        <div id="overall-stats-preview">Loading project statistics...</div>

        <script src='@assets.path("javascripts/lib/chart-4.5.1.min.js")'></script>
        <link rel="stylesheet" href="@assets.path("stylesheets/api-docs/overall-stats.css")">
        <script src="@routes.Assets.versioned("javascripts/api-docs/overall-stats-preview.js")"></script>
        <script>
            // Initialize the overall stats preview visualization.
            document.addEventListener('DOMContentLoaded', function() {
                OverallStatsPreview.setup({
                    apiBaseUrl: document.documentElement.getAttribute('data-api-base-url') || 'http://localhost:9000/v3/api',
                    // Pass the city name from the template to the JavaScript.
                    cityName: '@cityName'
                }).init();
            });
        </script>
    </div>

    <div class="api-section" id="endpoint-section">
        <h2 class="api-heading" id="endpoint">Endpoint <a href="#endpoint" class="permalink">#</a></h2>
        <p>Retrieve overall statistics for the entire Project Sidewalk dataset.</p>
        <p><code>GET /v3/api/overallStats</code></p>
        <div class="api-subsection" id="endpoint-example-section">
            <h3 class="api-heading" id="endpoint-examples">Examples<a href="#endpoint-examples" class="permalink">#</a></h3>
            <p><code><a target="_blank" href="/v3/api/overallStats?filetype=json">/v3/api/overallStats?filetype=json</a></code> Get overall stats for @cityName in JSON (default)</p>
            <p><code><a href="/v3/api/overallStats?filetype=csv">/v3/api/overallStats?filetype=csv</a></code> Get overall stats for @cityName in CSV</p>
        </div>
    </div>

    <div class="api-section" id="quick-download-section">
        <h2 class="api-heading" id="quick-download">Quick Download <a href="#quick-download" class="permalink">#</a></h2>
        <p>Download overall statistics data directly in your preferred format:</p>

        <div class="download-buttons">
            <button class="download-btn" data-format="json">
                <span class="format-icon">ðŸ“„</span> JSON
                <span class="format-hint">Standard format</span>
            </button>
            <button class="download-btn" data-format="csv">
                <span class="format-icon">ðŸ“Š</span> CSV
                <span class="format-hint">For Excel, Google Sheets</span>
            </button>
        </div>

        <div id="download-status" class="download-status" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="status-message">Preparing your download...</div>
            <div class="status-progress">This should only take a few seconds.</div>
        </div>
    </div>

    <div class="api-section" id="query-parameters-section">
        <h2 class="api-heading" id="query-parameters">Query Parameters<a href="#query-parameters" class="permalink">#</a></h2>
        <p>This endpoint accepts the following optional query parameters.</p>

        <div class="api-table-wrapper">
            <table class="api-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Type</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>filterLowQuality</code></td>
                        <td><code>boolean</code></td>
                        <td>When set to <code>true</code>, excludes data from low-quality contributors to provide
                            more reliable statistics. Default: <code>false</code> (includes all data).</td>
                    </tr>
                    <tr>
                        <td><code>filetype</code></td>
                        <td><code>string</code></td>
                        <td>Specify the output format. Options: <code>json</code> (default), <code>csv</code>.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="api-section" id="responses-section">
        <h2 class="api-heading" id="responses">Responses<a href="#responses" class="permalink">#</a></h2>

        <h3 class="api-heading" id="success-response-200-ok">Success Response (200 OK)<a href="#success-response-200-ok" class="permalink">#</a></h3>
        <p>
            On success, the API returns an HTTP <code>200 OK</code> status code and the requested data in the specified
            <code>filetype</code> format.
        </p>

        <h4 id="response-json">JSON Format (Default) <a href="#response-json" class="permalink">#</a></h4>
        <p>Returns a JSON object with comprehensive project statistics:</p>
        <pre><code class="language-json">{
    "launch_date": "2021-06-15T00:00:00Z",
    "avg_timestamp_last_100_labels": "2023-09-25T14:32:47Z",
    "km_explored": 1834.26,
    "km_explored_no_overlap": 1523.75,
    "user_counts": {
        "all_users": 4287,
        "labelers": 3892,
        "validators": 895,
        "registered": 3456,
        "anonymous": 831,
        "turker": 214,
        "researcher": 42
    },
    "labels": {
        "label_count": 183427,
        "label_count_with_severity": 162320,
        "avg_label_timestamp": "2021-05-10T20:20:25.147504Z",
        "avg_age_of_image_when_labeled": "672 days",
        "CurbRamp": {
            "count": 72964,
            "count_with_severity": 61837,
            "severity_mean": 1.2,
            "severity_sd": 0.5
        },
        "NoCurbRamp": {
            "count": 35682,
            "count_with_severity": 31245,
            "severity_mean": 3.8,
            "severity_sd": 0.9
        },
        // Some label types like NoSidewalk and Signal don't have severity ratings, so severity fields are null.
        "NoSidewalk": {
            "count": 61837,
            "count_with_severity": null,
            "severity_mean": null,
            "severity_sd": null
        },
        ... // Remaining label types
    },
    "validations": {
        "total_validations": 125834,
        "Overall": {
            "validated": 151196,
            "agreed": 127564,
            "disagreed": 23632,
            "accuracy": 0.84,
            "has_a_validation": 162974
        },
        "CurbRamp": {
            "validated": 54321,
            "agreed": 48923,
            "disagreed": 5398,
            "accuracy": 0.90,
            "has_a_validation": 59422
        },
        "NoCurbRamp": {
            "validated": 21456,
            "agreed": 18237,
            "disagreed": 3219,
            "accuracy": 0.85,
            "has_a_validation": 26100
        },
        ... // Remaining label types
    },
    "ai_stats": {
        "Overall": {
            "human_majority_vote": {
                "ai_yes_human_concurs": 37,
                "ai_yes_human_differs": 3,
                "ai_no_human_differs": 2,
                "ai_no_human_concurs": 37
            },
            "admin_majority_vote": {
                "ai_yes_human_concurs": 127,
                "ai_yes_human_differs": 54,
                "ai_no_human_differs": 27,
                "ai_no_human_concurs": 134
            }
        },
        "CurbRamp": {
            "human_majority_vote": {
                "ai_yes_human_concurs": 20,
                "ai_yes_human_differs": 0,
                "ai_no_human_differs": 0,
                "ai_no_human_concurs": 2
            },
            "admin_majority_vote": {
                "ai_yes_human_concurs": 42,
                "ai_yes_human_differs": 2,
                "ai_no_human_differs": 6,
                "ai_no_human_concurs": 48
            }
        },
        ... // Remaining label types
    }
}</code></pre>

        <h5 id="json-fields">JSON Field Descriptions <a href="#json-fields" class="permalink">#</a></h5>
        <p>The response includes the following fields:</p>

        <div class="api-table-wrapper">
            <table class="api-table">
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Type</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td><code>launch_date</code></td><td><code>string</code></td><td>ISO 8601 formatted date when Project Sidewalk was launched in this city.</td></tr>
                    <tr><td><code>avg_timestamp_last_100_labels</code></td><td><code>string</code></td><td>ISO 8601 formatted average timestamp of the 100 most recent labels, indicating data recency.</td></tr>
                    <tr><td><code>km_explored</code></td><td><code>number</code></td><td>Total kilometers of streets explored by all users, including overlapping streets.</td></tr>
                    <tr><td><code>km_explored_no_overlap</code></td><td><code>number</code></td><td>Total kilometers of unique streets explored, excluding overlapping streets.</td></tr>
                    <tr><td><code>user_counts.all_users</code></td><td><code>integer</code></td><td>Total number of users who have contributed to Project Sidewalk.</td></tr>
                    <tr><td><code>user_counts.labelers</code></td><td><code>integer</code></td><td>Number of users who have participated in explore/labeling tasks.</td></tr>
                    <tr><td><code>user_counts.validators</code></td><td><code>integer</code></td><td>Number of users who have participated in validation tasks.</td></tr>
                    <tr><td><code>user_counts.registered</code></td><td><code>integer</code></td><td>Number of users who have created accounts on Project Sidewalk.</td></tr>
                    <tr><td><code>user_counts.anonymous</code></td><td><code>integer</code></td><td>Number of anonymous users.</td></tr>
                    <tr><td><code>user_counts.turker</code></td><td><code>integer</code></td><td>Number of users from crowdsourcing platforms.</td></tr>
                    <tr><td><code>user_counts.researcher</code></td><td><code>integer</code></td><td>Number of users with the researcher role (includes all Admins).</td></tr>
                    <tr><td><code>labels</code></td><td><code>object</code></td><td>Statistics about label counts and severity ratings by label type.</td></tr>
                    <tr><td><code>labels.label_count</code></td><td><code>integer</code></td><td>Total number of accessibility labels placed by all users.</td></tr>
                    <tr><td><code>labels.label_count_with_severity</code></td><td><code>integer</code></td><td>Total number of labels placed by all users with an associated severity rating.</td></tr>
                    <tr><td><code>avg_label_timestamp</code></td><td><code>string</code></td><td>ISO 8601 formatted average timestamp when labels were created.</td></tr>
                    <tr><td><code>labels.avg_age_of_image_when_labeled</code></td><td><code>string</code></td><td>The average, across all labels, of the age of the image when the label was placed (in days).</td></tr>
                    <tr><td><code>labels.[type].count</code></td><td><code>integer</code></td><td>Total number of labels of this type.</td></tr>
                    <tr><td><code>labels.[type].count_with_severity</code></td><td><code>integer | null</code></td><td>Number of labels of this type that have severity ratings, or null if no severity ratings exist.</td></tr>
                    <tr><td><code>labels.[type].severity_mean</code></td><td><code>number | null</code></td><td>Mean severity rating for this label type, or null if no severity ratings exist.</td></tr>
                    <tr><td><code>labels.[type].severity_sd</code></td><td><code>number | null</code></td><td>Standard deviation of severity ratings for this label type, or null if insufficient data.</td></tr>
                    <tr><td><code>validations</code></td><td><code>object</code></td><td>Statistics about validation accuracy by label type.</td></tr>
                    <tr><td><code>validations.total_validations</code></td><td><code>integer</code></td><td>Total number of validation judgments made across all labels.</td></tr>
                    <tr><td><code>validations.[type].validated</code></td><td><code>integer</code></td><td>Number of labels of this type that have been validated as either "correct" or "incorrect" through majority vote; a label is not included if the number of agree and disagree votes are equal.</td></tr>
                    <tr><td><code>validations.[type].agreed</code></td><td><code>integer</code></td><td>Number of labels of this type that have been validated as "correct" through majority vote.</td></tr>
                    <tr><td><code>validations.[type].disagreed</code></td><td><code>integer</code></td><td>Number of labels of this type that have been validated as "incorrect" through majority vote</td></tr>
                    <tr><td><code>validations.[type].accuracy</code></td><td><code>number | null</code></td><td>Calculated accuracy rate (agreed / validated) for this label type, or null if no validations.</td></tr>
                    <tr><td><code>validations.[type].validated</code></td><td><code>integer</code></td><td>Number of labels of this type that have received any validation votes.</td></tr>
                    <tr><td><code>ai_stats</code></td><td><code>object</code></td><td>Statistics human agreement with AI validations.</td></tr>
                    <tr><td><code>ai_stats.[type].[vote]</code></td><td><code>object</code></td><td>Vote can be either "human" for majority vote across all users, or "admin" for majority vote across admin users.</td></tr>
                    <tr><td><code>ai_stats.[type].[vote].ai_yes_human_concurs</code></td><td><code>object</code></td><td>Number of labels where AI voted yes and human users voted yes more often than no.</td></tr>
                    <tr><td><code>ai_stats.[type].[vote].ai_yes_human_differs</code></td><td><code>object</code></td><td>Number of labels where AI voted yes but human users voted no more often than yes.</td></tr>
                    <tr><td><code>ai_stats.[type].[vote].ai_no_human_differs</code></td><td><code>object</code></td><td>Number of labels where AI voted no but human users voted yes more often than no.</td></tr>
                    <tr><td><code>ai_stats.[type].[vote].ai_no_human_concurs</code></td><td><code>object</code></td><td>Number of labels where AI voted no and human users voted no more often than yes.</td></tr>
                </tbody>
            </table>
        </div>

        <h4 id="response-csv">CSV Format <a href="#response-csv" class="permalink">#</a></h4>
        <p>If <code>filetype=csv</code> is specified, the response body will be CSV data with key-value pairs. Each row represents a different statistic or metric:</p>
        <pre><code class="language-csv">Launch Date,2021-06-15
Recent Labels Average Timestamp,2023-09-25T14:32:47Z
KM Explored,1834.26
KM Explored Without Overlap,1523.75
Total User Count,4287
Explore User Count,3892
Validate User Count,895
Registered User Count,3456
Anonymous User Count,831
Turker User Count,214
Researcher User Count,42
Total Label Count,183427
Total Label Count With Severity,162320
Average Label Timestamp,2021-05-10T20:20:25.147504Z
Average Age of Image When Labeled,672 days
CurbRamp Count,72964
CurbRamp Count With Severity,61837
CurbRamp Severity Mean,1.2
CurbRamp Severity SD,0.5
...
Total Validations,125834
Overall Labels Validated,151196
Overall Agreed Count,127564
Overall Disagreed Count,23632
Overall Accuracy,0.84
Overall Labels With a Validation,162974
CurbRamp Labels Validated,54321
CurbRamp Agreed Count,48923
CurbRamp Disagreed Count,5398
CurbRamp Accuracy,0.90
CurbRamp Labels With a Validation,59422
...
Overall AI Yes and Human Majority Vote Concurs,37
Overall AI Yes but Human Majority Vote Differs,3
Overall AI No but Human Majority Vote Differs,2
Overall AI No and Human Majority Vote Concurs,37
Overall AI Yes and Admin Majority Vote Concurs,127
Overall AI Yes but Admin Majority Vote Differs,54
Overall AI No but Admin Majority Vote Differs,27
Overall AI No and Admin Majority Vote Concurs,134
CurbRamp AI Yes and Human Majority Vote Concurs,20
CurbRamp AI Yes but Human Majority Vote Differs,0
CurbRamp AI No but Human Majority Vote Differs,0
CurbRamp AI No and Human Majority Vote Concurs,2
CurbRamp AI Yes and Admin Majority Vote Concurs,42
CurbRamp AI Yes but Admin Majority Vote Differs,2
CurbRamp AI No but Admin Majority Vote Differs,6
CurbRamp AI No and Admin Majority Vote Concurs,48
...</code></pre>

        <h5 id="csv-fields">CSV Format Description <a href="#csv-fields" class="permalink">#</a></h5>
        <p>In CSV format, each row represents a specific metric in a key-value format:</p>
        <ul>
            <li>Top-level statistics are represented directly as named rows (e.g., "KM Explored,1834.26")</li>
            <li>Nested statistics like <code>user_counts</code> and <code>labels</code> are flattened into multiple rows with descriptive names</li>
            <li>For each label type, label severity stats are presented as four rows: Count, Count With Severity, Severity Mean, and Severity SD</li>
            <li>For each label type, validation stats are presented as four rows: Labels Validated, Agreed Count, Disagreed Count, and Accuracy</li>
            <li>This flat structure makes the data easy to parse and analyze in spreadsheet applications</li>
        </ul>

        <h3 class="api-heading" id="error-responses">Error Responses<a href="#error-responses" class="permalink">#</a></h3>
        <p>If an error occurs, the API will return an appropriate HTTP status code and a JSON response body containing details about the error.</p>
        <ul>
            <li><strong><code>400 Bad Request</code>:</strong> Invalid parameter values.</li>
            <li><strong><code>404 Not Found</code>:</strong> The requested resource does not exist.</li>
            <li><strong><code>500 Internal Server Error</code>:</strong> An unexpected error occurred on the server.</li>
            <li><strong><code>503 Service Unavailable</code>:</strong> The server is temporarily unable to handle the request.</li>
        </ul>

        <h4 id="error-body">Error Response Body <a href="#error-body" class="permalink">#</a></h4>
        <p>Error responses include a JSON body with the following structure:</p>
        <pre><code class="language-json">{
    "status": 400, // HTTP Status Code
    "code": "INVALID_PARAMETER", // Machine-readable error code
    "message": "Invalid value for filetype parameter. Expected 'csv' or 'json'.", // Human-readable description
    "parameter": "filetype" // Optional: The specific parameter causing the error
}</code></pre>
    </div>

    <div class="api-section" id="best-practices-section">
        <h2 class="api-heading" id="data-analysis-tips">Data Analysis Tips <a href="#data-analysis-tips" class="permalink">#</a></h2>
        <p>
            The Overall Stats API provides a comprehensive view of Project Sidewalk data. Here are some suggestions for
            effectively using this data:
        </p>
        <ul>
            <li><strong>Consider using filterLowQuality=true</strong> for more reliable analysis, especially when examining severity ratings</li>
            <li><strong>Compare accuracy rates across label types</strong> to identify which accessibility issues might be more ambiguous or difficult to detect</li>
            <li><strong>Use km_explored vs. km_explored_no_overlap</strong> to understand the level of redundancy in data collection</li>
            <li><strong>Look at avg_timestamp_last_100_labels</strong> to gauge how recently the data has been updated</li>
            <li><strong>Analyze the ratio of validators to explorers</strong> to understand community participation patterns</li>
        </ul>

        <div class="api-callout">
            <h3><i class="icon icon-code"></i> Related APIs</h3>
            <p>
                For more detailed analysis, consider using the Overall Stats API in conjunction with:
            </p>
            <ul>
                <li><a href="@routes.ApiDocsController.userStats">User Stats API</a> - Get statistics for individual users and their contributions</li>
                <li><a href="@routes.ApiDocsController.rawLabels">Raw Labels API</a> - Access the individual label data with geographic information</li>
                <li><a href="@routes.ApiDocsController.labelTypes">Label Types API</a> - Get information about the different types of accessibility issues</li>
                <li><a href="@routes.ApiDocsController.cities">Cities API</a> - See all cities where Project Sidewalk is deployed</li>
            </ul>
        </div>
    </div>
}

@common.main(commonData, "API Docs") {
    @common.navbar(commonData, Some(user))
    @apiDocs.layout("overall-stats")(content)
}
