@* Assumes activePage is passed correctly to identify this page in the sidebar *@
@(activePage: String = "rawLabels")(implicit request: RequestHeader, assets: AssetsFinder)

@content = {
<div class="api-section" id="raw-labels-intro-section"> @* ID on section is optional, but distinct from heading ID *@
  <h1 class="api-heading" id="raw-labels-api">Raw Labels API <a href="#raw-labels-api" class="permalink">#</a></h1> 
  <p>
    The Raw Labels API provides access to individual geo-located labels placed by Project Sidewalk users.
    Each label represents a sidewalk feature or barrier that has been identified and categorized in street view imagery.
  </p>
  <p>
    This endpoint returns raw, unclustered data. For most applications, we recommend using the <a href="TODO">Label Clusters API</a>
    as it groups potentially duplicate labels of the same feature using a custom clustering algorithm. Use this Raw Labels API
    when you need access to every individual label record, including metadata about the user (anonymized) and validation status.
  </p>
</div>

<div class="api-section" id="raw-labels-preview-section">
  <h2 class="api-heading" id="visual-example">Raw Labels API Preview <a href="#visual-example" class="permalink">#</a></h2>
  <p>Below is a live preview of raw labels from a sample region retrieved directly from the API. 
    Depending on the number of labels in the region, it may take a bit to load.</p>
  
  <div id="raw-labels-preview">Loading raw labels data...</div>
  
  <!-- TODO: Ask Mikey if we should be incorporating css and js from unpkg or loading them some other way -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <link rel="stylesheet" href="@assets.path("stylesheets/api-docs/raw-labels.css")">
  <script src="@routes.Assets.versioned("javascripts/api-docs/raw-labels-preview.js")"></script>
  <script>
    // Initialize the raw labels preview map
    document.addEventListener('DOMContentLoaded', function() {
      RawLabelsPreview.setup({
        mapHeight: 500
      }).init();
    });
  </script>

  <p class="download-note">
    Note: In this example, we are visualizing Project Sidewalk data only in a single region; however, the Raw Labels API can return data 
    from all regions in the city or just a selected region‚Äîsee the API query parameters below.
  </p>
</div>

<div class="api-section" id="endpoint-section">
  <h2 class="api-heading" id="endpoint">Endpoint <a href="#endpoint" class="permalink">#</a></h2> 
  <p>Retrieve a list of raw labels, optionally filtered by various criteria.</p>
  <p><code>GET /api/v3/rawLabels</code></p>
  <p><strong>Base URL:</strong> <code>https://api.projectsidewalk.org/v2</code> </p>
</div>

<!-- Add this script in the page template where appropriate -->
<script>
  console.log('Setting data attributes for API information');
  //TODO UPDATE THE URL
  document.documentElement.setAttribute('data-api-base-url', 'http://localhost:9000/v3');
  document.documentElement.setAttribute('data-api-endpoint', 'rawLabels');
  console.log('Data attributes set:', {
    'data-api-base-url': document.documentElement.getAttribute('data-api-base-url'),
    'data-api-endpoint': document.documentElement.getAttribute('data-api-endpoint')
  });
</script>

<div class="api-section" id="quick-download-section">
  <h2 class="api-heading" id="quick-download">Quick Download <a href="#quick-download" class="permalink">#</a></h2>
  <p>
    Download raw labels data directly in your preferred format:
  </p>
  
  <div class="download-buttons">
    <button class="download-btn" data-format="csv">
      <span class="format-icon">üìä</span> CSV
      <span class="format-hint">For Excel, Google Sheets</span>
    </button>
    <button class="download-btn" data-format="shapefile">
      <span class="format-icon">üó∫Ô∏è</span> Shapefile
      <span class="format-hint">For ArcGIS, QGIS</span>
    </button>
    <button class="download-btn" data-format="geopackage">
      <span class="format-icon">üì¶</span> GeoPackage
      <span class="format-hint">Open GIS format</span>
    </button>
    <button class="download-btn" data-format="geojson">
      <span class="format-icon">üìù</span> GeoJSON
      <span class="format-hint">Web mapping standard</span>
    </button>
  </div>
  
  <div id="download-status" class="download-status" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="status-message">Generating your download...</div>
    <div class="status-progress">This may take anywhere from a few seconds to a few minutes depending on the data size.</div>
  </div>
  
  <p class="download-note">
    Note: This downloads all raw labels. For filtered data, use the API query parameters described below.
  </p>
</div>

<div class="api-section" id="query-parameters-section">
  <h2 class="api-heading" id="query-parameters">Query Parameters<a href="#query-parameters" class="permalink">#</a></h2> 
  <p>
    Filter the raw labels returned by this endpoint using the following query parameters. All parameters are optional.
    Combine multiple filter parameters to narrow down results (filters are applied using AND logic). When multiple location filters are provided (<code>bbox</code>, <code>region_id</code>, and <code>region_name</code>), <code>bbox</code> takes precedence over region filters, and <code>region_id</code> takes precedence over <code>region_name</code>.
  </p>

  <div class="api-table-wrapper">
    <table class="api-table">
      <thead>
        <tr>
          <th>Parameter</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>bbox</code></td>
          <td><code>string</code></td>
          <td>Filter labels by bounding box. Coordinates should be provided as a comma-separated string in the format: <code>minLongitude,minLatitude,maxLongitude,maxLatitude</code> (e.g., <code>-74.01,40.71,-74.00,40.72</code>). Uses WGS84 (EPSG:4326) coordinates. If omitted, results are not spatially filtered (potentially very large response).</td>
        </tr>
        <tr>
          <td><code>region_id</code></td>
          <td><code>integer</code></td>
          <td>Filter labels by region ID. Returns only labels within the specified region. Note: If both <code>bbox</code> and <code>region_id</code> are provided, <code>bbox</code> takes precedence.</td>
        </tr>
        <tr>
          <td><code>region_name</code></td>
          <td><code>string</code></td>
          <td>Filter labels by region name. Returns only labels within the specified region. Note: If <code>bbox</code> or <code>region_id</code> are provided, they take precedence over <code>region_name</code>.</td>
        </tr>
        <tr>
          <td><code>label_type</code></td>
          <td><code>string</code></td>
          <td>Filter by one or more label types. Provide comma-separated values (e.g., <code>label_type=CurbRamp,Obstacle</code>). See <a href="@routes.ApiDocsController.labelTypes()">Label Types Reference</a> for available types. </td>
        </tr>
        <tr>
          <td><code>tag</code></td>
          <td><code>string</code></td>
          <td>Filter by one or more tags associated with labels. Provide comma-separated values (e.g., <code>tag=missing_tactile_warning,uneven_surface</code>). Matches labels containing *any* of the specified tags. See <a href="#tags-reference">Tags Reference</a> for available tags. </td>
        </tr>
        <tr>
          <td><code>min_severity</code></td>
          <td><code>integer</code></td>
          <td>Filter labels with a severity rating greater than or equal to this value (1-5).</td>
        </tr>
        <tr>
            <td><code>max_severity</code></td>
            <td><code>integer</code></td>
            <td>Filter labels with a severity rating less than or equal to this value (1-5).</td>
        </tr>
        <tr>
          <td><code>validation_status</code></td>
          <td><code>string</code></td>
          <td>Filter by validation status. Possible values: <code>validated_correct</code>, <code>validated_incorrect</code>, <code>unvalidated</code>. </td>
        </tr>
        <tr>
            <td><code>start_date</code></td>
            <td><code>string</code></td>
            <td>Filter labels created on or after this date/time. Format: ISO 8601 (e.g., <code>2024-01-01T00:00:00Z</code>). Filters based on the <code>time_created</code> field.</td>
        </tr>
        <tr>
            <td><code>end_date</code></td>
            <td><code>string</code></td>
            <td>Filter labels created before this date/time. Format: ISO 8601 (e.g., <code>2024-12-31T23:59:59Z</code>). Filters based on the <code>time_created</code> field.</td>
        </tr>
        <tr>
          <td><code>filetype</code></td>
          <td><code>string</code></td>
          <td>Specify the output format. Options: <code>geojson</code> (default), <code>csv</code>, <code>shapefile</code>, <code>geopackage</code>.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="api-section" id="example-requests-section">
    <h3 class="api-heading" id="example-requests">Example Requests <a href="#example-requests" class="permalink">#</a></h3> 

    <h4 class="api-heading" id="curl-example">Curl Example <a href="#curl-example" class="permalink">#</a></h4> 
    <p>Request the first 50 Curb Ramps with severity 3 or higher within a specific bounding box, in GeoJSON format:</p>
    <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v2/rawLabels?bbox=-74.01,40.71,-74.00,40.72&label_type=CurbRamp&min_severity=3&limit=50"
# Base URL may differ
    </code></pre>

    <h4 class="api-heading" id="region-example">Region Filter Example <a href="#region-example" class="permalink">#</a></h4>
    <p>Request all Surface Problem labels within a specific region, in CSV format:</p>
    <pre><code class="language-bash">
curl "https://api.projectsidewalk.org/v2/rawLabels?region_name=Downtown&label_type=SurfaceProblem&filetype=csv"
# Base URL may differ
    </code></pre>

    <h4 class="api-heading" id="python-example">Python Example <a href="#python-example" class="permalink">#</a></h4> 
    <p>Request labels tagged 'missing_tactile_warning' created since the start of 2024, getting the second page of results (assuming default limit of 1000), in CSV format:</p>
    <pre><code class="language-python">
import requests

BASE_URL = "https://api.projectsidewalk.org/v2" # TODO: Confirm Base URL

params = {
    "tag": "missing_tactile_warning",
    "start_date": "2024-01-01T00:00:00Z",
    "filetype": "csv",
    "limit": 1000,
    "offset": 1000 # Skip the first 1000 results (page 1)
}

try:
    response = requests.get(f"{BASE_URL}/rawLabels", params=params)
    response.raise_for_status() # Raises HTTPError for bad responses (4XX, 5XX)

    # Process CSV data
    print("Response Status Code:", response.status_code)
    # print("CSV Data:\n", response.text[:500]) # Print first 500 chars of CSV

except requests.exceptions.RequestException as e:
    print(f"An error occurred: {e}")
    if e.response is not None:
        print("Error Response Body:", e.response.text)

    </code></pre>
     </div>

<div class="api-section" id="responses-section">
  <h2 class="api-heading" id="responses">Responses<a href="#responses" class="permalink">#</a></h2> 

  <h3 class="api-heading" id="success-response-200-ok">Success Response (200 OK)<a href="#success-response-200-ok" class="permalink">#</a></h3> 
  <p>
      On success, the API returns an HTTP <code>200 OK</code> status code and the requested data in the specified <code>filetype</code> format.
  </p>
  
  <h4 id="response-geojson">GeoJSON Format (Default) <a href="#response-geojson" class="permalink">#</a></h4>
  <p>Returns a GeoJSON FeatureCollection where each feature represents a single raw label. Coordinate Reference System (CRS) is WGS84 (EPSG:4326).</p>
  <pre><code class="language-json">
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [-74.005, 40.715] // [longitude, latitude]
      },
      "properties": {
        "label_id": 115,
        "user_id": "18b26a38-24ab-402d-a64e-158fc0bb8a8a", // Anonymized
        "gsv_panorama_id": "YQScv7YhLpOcw9a0FLsygA",
        "label_type": "CurbRamp",
        "severity": 2,
        "tags": [
          "missing tactile warning"
        ],
        "description": null,
        "time_created": 1678886400000, // Example timestamp (milliseconds since epoch)
        "street_edge_id": 12345,
        "osm_street_id": 67890,
        "neighborhood": "Example Neighborhood",
        "correct": true, // Based on validation
        "agree_count": 5,
        "disagree_count": 1,
        "unsure_count": 0,
        "validations": [ /* Array of validation details */ ],
        // ... other properties like pano info, camera angles etc.
      }
    }
    // ... more features up to the 'limit'
  ]
}
  </code></pre>

  <h5 id="geojson-fields">GeoJSON Field Descriptions <a href="#geojson-fields" class="permalink">#</a></h5>
  <p>The <code>properties</code> object within each GeoJSON feature contains the following fields:</p>
  
  <div class="api-table-wrapper">
    <table class="api-table">
        <thead> <tr> <th>Field Path</th> <th>Type</th> <th>Description</th> </tr> </thead>
        <tbody>
          <tr><td><code>properties.label_id</code></td><td><code>integer</code></td><td>Unique identifier for the label.</td></tr>
          <tr><td><code>properties.user_id</code></td><td><code>string</code></td><td>Anonymized unique identifier for the user who placed the label.</td></tr>
          <tr><td><code>properties.gsv_panorama_id</code></td><td><code>string</code></td><td>Google Street View panorama ID where the label was placed.</td></tr>
          <tr><td><code>properties.label_type</code></td><td><code>string</code></td><td>Type of the label (e.g., "CurbRamp", "SurfaceProblem").</td></tr>
          <tr><td><code>properties.severity</code></td><td><code>integer | null</code></td><td>Severity rating (1-5) assigned by the user, or null if none was assigned.</td></tr>
          <tr><td><code>properties.tags</code></td><td><code>array</code></td><td>Array of strings representing tags associated with the label.</td></tr>
          <tr><td><code>properties.temporary</code></td><td><code>boolean</code></td><td>Whether the label represents a temporary problem.</td></tr>
          <tr><td><code>properties.description</code></td><td><code>string | null</code></td><td>User-provided text description, or null if none.</td></tr>
          <tr><td><code>properties.time_created</code></td><td><code>long</code></td><td>Timestamp (milliseconds since epoch) when the label was created.</td></tr>
          <tr><td><code>properties.street_edge_id</code></td><td><code>integer</code></td><td>Identifier for the street segment the label is associated with.</td></tr>
          <tr><td><code>properties.osm_street_id</code></td><td><code>integer</code></td><td><a href="https://wiki.openstreetmap.org/wiki/Way">OpenStreetMap Way ID</a> for the street segment.</td></tr>
          <tr><td><code>properties.neighborhood</code></td><td><code>string</code></td><td>Name of the neighborhood the label falls within.</td></tr>
          <tr><td><code>properties.correct</code></td><td><code>boolean | null</code></td><td>Overall validation status based on agree/disagree counts (true, false, or null if not enough validations).</td></tr>
          <tr><td><code>properties.agree_count</code></td><td><code>integer</code></td><td>Number of users who agreed with this label during validation.</td></tr>
          <tr><td><code>properties.disagree_count</code></td><td><code>integer</code></td><td>Number of users who disagreed with this label during validation.</td></tr>
          <tr><td><code>properties.unsure_count</code></td><td><code>integer</code></td><td>Number of users who marked "unsure" for this label during validation.</td></tr>
          <tr><td><code>properties.validations</code></td><td><code>array</code></td><td>Array of individual validation objects (structure may vary).</td></tr>
          <tr><td><code>...</code></td><td><code>...</code></td><td><code>...</code></td></tr>
        </tbody>
    </table>
  </div>

  <h4 id="response-csv">CSV Format <a href="#response-csv" class="permalink">#</a></h4>
  <p>If <code>filetype=csv</code> is specified, the response body will be CSV data. The first row contains the headers, corresponding to the fields in the GeoJSON properties object, plus <code>latitude</code> and <code>longitude</code> columns derived from the geometry. CRS is WGS84 (EPSG:4326).</p>
  <pre><code class="language-csv">
label_id,user_id,gsv_panorama_id,label_type,severity,tags,description,time_created,...,correct,agree_count,disagree_count,unsure_count,latitude,longitude
115,"18b26a38-...","YQScv...","CurbRamp",2,"[""missing tactile warning""]",,1678886400000,...,true,5,1,0,40.715,-74.005
116,"...",...,"Obstacle",4,"[""construction""]","Temporary fence",1678886450000,...,false,1,3,0,40.7151,-74.0051
...
  </code></pre>
  <h4 id="response-shapefile">Shapefile Format <a href="#response-shapefile" class="permalink">#</a></h4> 
  <p>If <code>filetype=shapefile</code> is specified, the response body will be a ZIP archive containing the Shapefile components (.shp, .shx, .dbf, .prj). The attribute table (.dbf) contains fields corresponding to the GeoJSON properties object (field names may be truncated due to Shapefile limitations). The included <code>.prj</code> file defines the Coordinate Reference System (CRS), typically WGS84 (EPSG:4326). </p>

  <h4 id="response-geopackage">GeoPackage Format <a href="#response-geopackage" class="permalink">#</a></h4> 
  <p>If <code>filetype=geopackage</code> is specified, the response body will be a GeoPackage file (<code>.gpkg</code>). This is an open standard format based on SQLite that contains both geometry and attributes in a single file, generally without the field name limitations of Shapefiles. CRS is typically WGS84 (EPSG:4326). </p>


  <h3 class="api-heading" id="error-responses">Error Responses<a href="#error-responses" class="permalink">#</a></h3> 
  <p>If an error occurs, the API will return an appropriate HTTP status code and a JSON response body containing details about the error.</p>
  <ul>
    <li><strong><code>400 Bad Request</code>:</strong> Invalid parameter values (e.g., malformed bounding box, invalid date format).</li>
    <li><strong><code>404 Not Found</code>:</strong> The requested resource does not exist (e.g., incorrect base URL path).</li>
    <li><strong><code>500 Internal Server Error</code>:</strong> An unexpected error occurred on the server.</li>
    <li><strong><code>503 Service Unavailable</code>:</strong> The server is temporarily unable to handle the request (e.g., during maintenance).</li>
  </ul>

  <h4 id="error-body">Error Response Body <a href="#error-body" class="permalink">#</a></h4>
  <p>Error responses include a JSON body with the following structure:</p>
  <pre><code class="language-json">
{
  "status": 400, // HTTP Status Code repeated
  "code": "INVALID_PARAMETER", // Machine-readable error code
  "message": "Invalid value for bbox parameter. Expected format: minLon,minLat,maxLon,maxLat.", // Human-readable description
  "parameter": "bbox" // Optional: The specific parameter causing the error
}
  </code></pre>
</div>

<div class="api-section" id="data-licensing-section">
  <h2 class="api-heading" id="data-licensing-terms-of-use">Data Licensing & Terms of Use <a href="#data-licensing-terms-of-use" class="permalink">#</a></h2> 
  <p>
      TODO: this footer should be in the parent template and the same for every API page.
      Data provided through the Project Sidewalk API is subject to specific terms and conditions.
      Generally, the data is available under the TODO.
      Please refer to the full <a href="[TODO: Link to Terms of Use/License page]">Data Licensing Agreement</a> for details on permitted uses and attribution requirements.
  </p>
</div>

}

@* Use the main layout template, passing the active page identifier and the content block *@
@apiDocs.layout(activePage)(content)