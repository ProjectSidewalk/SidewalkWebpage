@import models.user.User
@import models.region.RegionTable
@import models.region.NamedRegion
@import models.mission.{MissionTable, Mission}
@import models.survey._
@import models.amt.AMTAssignmentTable
@import play.api.libs.json.Json
@import views.html.bootstrap._

@(title: String, task: Option[models.audit.NewTask] = None, mission: Mission, region: NamedRegion, missionSetProgress: Int, hasCompletedMission: Boolean, nextTempLabelId: Int, user: Option[User] = None, cityShortName: String, tutorialStreetId: Int, lat: Option[Double] = None, lng: Option[Double] = None, panoId: Option[String] = None, enableCVGroundTruthLabelingMode: Boolean = false)

@main(title, Some("/audit")) {
    @navbar(user, Some("/audit"))
    <script type="text/javascript" src='@routes.Assets.at("assets/detectMobileBrowser.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/SVLabel/build/SVLabel.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/SVLabel/lib/gsv/zpipe.min.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/SVLabel/lib/gsv/jquery.base64.min.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/SVLabel/lib/kinetic-v4.3.3.min.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("assets/detectUnsupportedBrowser.js")'></script>

    <link rel="stylesheet" href='@routes.Assets.at("javascripts/SVLabel/build/SVLabel.css")'/>
    <link rel="stylesheet" href='@routes.Assets.at("stylesheets/animate.css")'/>
    <div id="page-loading"><img id="loading-gif" src='@routes.Assets.at("assets/page-load.gif")'/></div>

    @if(Some(User)){
        <div class="modal fade" id="survey-modal-container" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" id="survey-modal">
                    <div class="modal-header">
                        <!-- only allow non-turkers to exit out of survey -->
                        @if(user.get.role.getOrElse("") != "Turker") {
                            <button type="button" class="close" id="survey-skip-button" data-dismiss="modal" aria-hidden="true">Ã—</button>
                        }
                        <h4 class="modal-title" id="sign-in-label">Please take this one-time survey about Project Sidewalk</h4>
                    </div>
                    <div class="modal-body">
                        <form id="surveyForm" method="post">
                            <ol>
                            @for(surveyQuestion <- SurveyQuestionTable.listAll){
                                <li>
                                @if(surveyQuestion.required == true) {
                                    <h4 class="survey-question">@surveyQuestion.surveyQuestionText *</h4>
                                } else {
                                    <h4 class="survey-question">@surveyQuestion.surveyQuestionText</h4>
                                }
                                @if(surveyQuestion.surveyInputType == "radio"){
                                    <ul class="survey-option-holder">
                                    @for(surveyOption <- SurveyQuestionTable.listOptionsByQuestion(surveyQuestion.surveyQuestionId).get){
                                        <li class="survey-option">
                                            @if(surveyQuestion.required == true){
                                                <input type="@surveyQuestion.surveyInputType" name="@surveyQuestion.surveyQuestionId" value="@surveyOption.surveyOptionId" required>
                                            } else{
                                                <input type="@surveyQuestion.surveyInputType" name="@surveyQuestion.surveyQuestionId" value="@surveyOption.surveyOptionId">
                                            }
                                            <label>@surveyOption.surveyOptionText</label>
                                        </li>
                                    }
                                    </ul>
                                }else{
                                    @if(surveyQuestion.surveyInputType == "checkbox"){
                                        <ul class="survey-option-holder">
                                        @for(surveyOption <- SurveyQuestionTable.listOptionsByQuestion(surveyQuestion.surveyQuestionId).get){
                                            <li class="survey-option">
                                                <input type="@surveyQuestion.surveyInputType" name="@surveyQuestion.surveyQuestionId" value="@surveyOption.surveyOptionId">
                                                <label>@surveyOption.surveyOptionText</label>
                                            </li>
                                        }
                                        </ul>
                                    } else{
                                        @if(surveyQuestion.surveyInputType == "free-text-feedback"){
                                            @if(surveyQuestion.required == true){
                                                <textarea class="survey-textarea" name="@surveyQuestion.surveyQuestionId" placeholder="" required></textarea>
                                            } else{
                                                <textarea class="survey-textarea" name="@surveyQuestion.surveyQuestionId" placeholder=""></textarea>
                                            }
                                        }
                                    }
                                }
                                </li>
                            }
                        </ol>
                            <button value="Submit" class="btn btn-sm btn-primary btn-block">Submit</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
}

    <div class="container toolUI" style = "visibility: hidden;">
        <div id="advanced-overlay">
            <div class="overlay-text">
                <div id="advanced-neighborhood-text">
                    <p>
                        <span class="overlay-header">Advanced Neighborhood</span>
                    </p>
                    <p>
                        <b>Warning:</b> This neighborhood is difficult to travel and is only recommended for experienced users. Are you sure you would like to explore this neighborhood?
                    </p>
                    <p>
                        If you get stuck, click the Jump button to navigate to a different area.
                    </p>
                    <span class="overlay-option" id="continue-advanced">Yes, continue in this neighborhood</span>
                    <span class="overlay-option" id="redirect-advanced">No, go to another neighborhood</span>
                </div>
            </div>
        </div>
        <div id="neighborhood-completion-overlay">
            <div class="overlay-text">
                <div id="neighborhood-completion-text">
                    <p>
                        <span class="overlay-header">Neighborhood Completed!</span>
                    </p>
                    <p>
                        <b>Hurray!</b> You just helped complete this neighborhood! You can:
                    </p>
                    <span class="overlay-option" id="continue-current">Continue in this neighborhood</span>
                    <span class="overlay-option" id="redirect-new">Go to a new neighborhood</span>
                </div>
            </div>
        </div>
        <div id="cvgroundtruth-complete-overlay">
            <div class="overlay-text">
                <div id="cvgroundtruth-complete-overlay-text">
                    <p>
                        <span class="overlay-header">CV Ground Truth Audit Complete!</span>
                    </p>
                </div>
            </div>
        </div>
        <div id="already-completed-neighborhood-overlay">
            <div class="overlay-text">
                <div id="already-completed-neighborhood-text">
                    <p>
                        <span class="overlay-header">Neighborhood Already Complete!</span>
                    </p>
                    <p>
                        You already audited this entire neighborhood! We are going to send you to a neighborhood that could use some auditing.
                    </p>
                    <span class="overlay-option" id="accept-redirect">OK</span>
                </div>
            </div>
        </div>
        <div id="HIT-expiration-overlay">
            <div class="overlay-text">
                <div id="HIT-expiration-text">
                    <p>
                        <span class="overlay-header">Assignment Expired!</span>
                    </p>
                    <p>
                        You should receive your bonus amount in the next day or two. If you completed the HIT but did
                        not submit your confirmation code on the mturk website, send us an email at
                        <a href="mailto:makeability.sidewalk@@gmail.com">makeability.sidewalk@@gmail.com</a> with your
                        confirmation code (@{models.mission.MissionTable.getMostRecentConfirmationCodeIfCompletedAuditMission(user.get.username).getOrElse("")}).
                    </p>
                </div>
            </div>
        </div>
        <div class="page-alert-holder" id="unsupported-browser-alert" style="visibility: hidden">
            <div class="page-alert">
                <span id="page-alert-message"><strong>Disclaimer:</strong> This site is optimized for Google Chrome. Other browsers are not fully supported yet.&nbsp;</span>

                <a id="page-alert-close" onClick="hideBrowserVersionAlert();" href="#"><span class="glyphicon glyphicon-remove"></span></a>
            </div>
        </div>
        <div id="svl-application-holder">
            <div id="left-column-control-pane">
                <div id="left-column-button-holder">
                    <div id="left-column-confirmation-code-button" class="button">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Icon_OrangeCheckmark.png")'  alt="Confirmation Code icon" align="">
                        Mturk Code
                    </div>
                    <div id="left-column-sound-button" class="button">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/sound.png")' id="left-column-sound-icon" class="visible" alt="Sound icon" align="">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/sound_mute.png")' id="left-column-mute-icon" class="hidden" alt="Mute icon" align="">
                        Sound
                    </div>
                    <div class="spacer10"></div>
                    <div id="left-column-jump-button" class="button">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/refresh.png")'  alt="Jump icon" align="">
                        Jump
                    </div>
                    <div class="spacer10"></div>
                    <div id="left-column-feedback-button" class="button">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/comment.png")'  alt="Comment icon" align="">
                        Feedback
                    </div>
                </div>
            </div>
            <div id="ribbon-menu-holder">
                <span id="ribbon-menu-left-column-holder">
                    <div id="ribbon-menu-left-column-title"></div>
                    <div id="ribbon-menu-left-column-button-holder">
                        <span class="modeSwitch" val="Walk" id="modeSwitchWalk" style="">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Icon_Walker.png")'  id="icon-explore" class="icon-ribbon-menu-large" alt="Mode switch: Walk" align="">
                            </span>
                            <span class="modeSwitch_Name" style="position:absolute; left: 0px;"><u>E</u>xplore</span>
                            <div id="ribbon-mode-switch-horizontal-line-walk" class="ribbon-menu-mode-switch-horizontal-line" val="Walk"></div>
                        </span>
                    </div>
                </span>
                <span id="label-type-holder">
                    <div id="ribbon-menu-label-type-title">
                        Find and label the following
                    </div>
                    <div id="ribbon-menu-label-type-button-holder">
                        <span id="ModeSwitchButton_CurbRamp" class="modeSwitch" val="CurbRamp">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_CurbRamp.svg")' class="icon-ribbon-menu-large" alt="Mode switch:" align="">
                            </span>
                            <div class="modeSwitch_Name"><u>C</u>urb Ramp</div>
                            <div class="ribbon-menu-mode-switch-horizontal-line" val="CurbRamp"></div>
                        </span>
                        <span id="ModeSwitchButton_NoCurbRamp" class="modeSwitch" val="NoCurbRamp">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_NoCurbRamp.svg")' class="icon-ribbon-menu-large" alt="Mode switch:" align="">
                            </span>
                            <span class="modeSwitch_Name"><u>M</u>issing Curb Ramp</span>
                            <div class="ribbon-menu-mode-switch-horizontal-line" val="NoCurbRamp"></div>
                        </span>
                        <span id="ModeSwitchButton_Obstacle" class="modeSwitch" val="Obstacle">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_Obstacle.svg")' class="icon-ribbon-menu-large" alt="Mode switch:" align="">
                            </span>
                            <span class="modeSwitch_Name"><span class="underline">O</span>bstacle in <br /> Path</span>
                            <div class="ribbon-menu-mode-switch-horizontal-line" val="Obstacle"></div>
                        </span>
                        <span id="ModeSwitchButton_SurfaceProblem" class="modeSwitch" val="SurfaceProblem">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_SurfaceProblem.svg")' class="icon-ribbon-menu-large" alt="Mode switch:" align="">
                            </span>
                            <span class="modeSwitch_Name"><span class="underline">S</span>urface Problem</span>
                            <div class="ribbon-menu-mode-switch-horizontal-line" val="SurfaceProblem"></div>
                        </span>
                        <span id="ModeSwitchButton_NoSidewalk" class="modeSwitch" val="NoSidewalk">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_NoSidewalk.svg")' class="icon-ribbon-menu-large" alt="Mode switch:" align="">
                            </span>
                            <span class="modeSwitch_Name"><span class="underline">N</span>o Sidewalk</span>
                            <div class="ribbon-menu-mode-switch-horizontal-line" val="NoSidewalk"></div>
                        </span>
                        <span id="ModeSwitchButton_Other" class="modeSwitch" val="Other">
                            <span class="modeSwitch_Icon">
                                <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_Other2.svg")' class="icon-ribbon-menu-large" alt="Mode switch:" align="">
                            </span>
                            <span class="modeSwitch_Name">
                                Other
                            </span>
                            <div class="ribbon-menu-mode-switch-horizontal-line" val="Other"></div>
                            <div id="ribbon-menu-other-subcategory-holder">
                                <div class="ribbon-menu-other-subcategories" val="Occlusion">
                                    <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_Occlusion.png")' class="icon-ribbon-menu-medium" alt="Occluded sidewalk icon">
                                    Can't see the sidewalk (<span class="underline">B</span>)
                                </div>
                                <div class="ribbon-menu-other-subcategories" val="Other">
                                    <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_Other.png")' class="icon-ribbon-menu-medium" alt="Other icon">
                                    Other
                                </div>
                            </div>
                        </span>
                    </div>
                </span>
            </div>
            <div id="zoom-control-holder"></div>
            <div id="action-stack-control-holder"></div>
            <div id="status-holder">
                <div class="status-box">
                    <h1 class="status-holder-header-1">Current Neighborhood</h1>

                    <h2><span id="status-holder-neighborhood-name"></span>@cityShortName</h2>

              <!--      <a href="" target="_blank" id="status-neighborhood-link">
                        <h2 id="link-neighborhood-name"><span id="status-holder-neighborhood-name"></span>D.C.</h2>
                    </a>-->

                    <div class="status-row" id="neighborhood-status-row">
                        <span class="status-column-half">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/WalkingFeet2.png")' class="status-icon" alt="Map icon" align="">
                            <span><span class="bold" id="status-audited-distance">0.00</span> <small>miles</small></span>
                        </span>
                        <span class="status-column-half">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Sidewalk/Icon_Other.png")' class="status-icon" alt="Total label count" align="">
                            <span><span class="bold" id="status-neighborhood-label-count">0</span> <small>labels</small></span>
                        </span>
                    </div>
                </div>
                <div class="status-box">
                    <h1>Current Mission</h1>
                    <h2 id="current-mission-description">Let's make this neighborhood accessible</h2>
                    <div id='status-current-mission-completion-bar'>
                        <div id='status-current-mission-completion-bar-filler'>
                            <div id='status-current-mission-completion-rate'></div>
                        </div>
                    </div>
                    <br class="clear">
                    <h2 id="current-mission-reward" style="display:none"></h2>
                    <h2 id="total-mission-reward" style="display:none"></h2>
                </div>
                <div class="status-box">
                    <div id="label-counter"></div>
                </div>
            </div>
            <div id="next-pano-button-holder">
                <div id="groundtruth-info-panel">
                    <button type="button" class="button" id="next-pano-btn" onClick="svl.cvGroundTruthMission.cvGroundTruthNextPano();">Next Pano</button>
                    <p id="remaining-pano-text">50 remaining</p>
                    <p id="current-panoid-text"></p>
                </div>
            </div>
            <div id="interaction-area-holder" onSelectStart="return true;">
                <div id="alert-holder" style="display: none">
                    <div id="alert">
                        <span id="alert-message"></span>
                        <a id="alert-dont-show" href="#">Don't show again</a>
                        <a id="alert-close" href="#"><span class="glyphicon glyphicon-remove"></span></a>
                    </div>
                </div>
                <div id="street-view-holder">
                    <div id="svl-panorama-date-holder">
                        <span id="svl-panorama-date"></span>
                    </div>
                    <div id="ribbon-street-view-connector"><!-- border --></div>
                    <!-- You can put an extra div element on top of the Street View div panel to disable any of StreetView control. -->
                    <div id="pano" class="Window_StreetView" style="z-index: 0;" ></div>
                    <div id="overlay-message-holder" class="Window_StreetView"></div>
                    <div id="onboarding-holder" class="Window_StreetView">
                        <canvas id="onboarding-canvas"  class="Window_StreetView" width="720px" height="480px" style="cursor: default, move;"></canvas>
                        <div id="hand-gesture-holder"></div>
                        <div id="onboarding-background"></div>
                        <div id="onboarding-message-holder" class="white-background">
                            <p></p>
                        </div>
                        <div style="display:none;">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/onboarding/DoubleClick.png")' id="double-click-icon" width="200" alt="Double click icon"/>
                        </div>
                    </div>
                    <div id="userControlLayer"  class="Window_StreetView" style="z-index: 0;">
                        <div id="viewControlLayer"  class="Window_StreetView" style="cursor: url(/assets/javascripts/SVLabel/img/cursors/openhand.cur) 4 4, move; z-index: 1;">
                            <!-- In IE, it seems like a div element that has nothing inside gets neglected...
                                So I put an empty canvas as a place holder.
                            -->
                            <!--[if IE]>
                            <canvas width="720px" height="480px"  class="Window_StreetView" style=""></canvas>
                            <![endif]-->
                        </div>
                        <div id="labelDrawingLayer"  class="Window_StreetView" style="z-index: 0;">
                            <canvas id="label-canvas"  class="Window_StreetView" width="720px" height="480px" style="cursor: default, move;"></canvas>
                        </div>
                    </div>

                    <div id="delete-icon-holder">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Icon_Delete.png")' id="LabelDeleteIcon" />
                    </div>
                    <div id="Holder_LabelEditIcon">
                        <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/Icon_Edit.png")' id="LabelEditIcon" />
                    </div>
                    <div id="context-menu-holder">
                        <div id="context-menu-close-button-holder">
                            <button type="button" id="context-menu-close-button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div id="severity-menu">
                            <div id="severity-radio-holder">
                                <div class="radio-inline" id="column-passable">
                                    <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/WheelchairAccessible-2.png")'
                                        class="context-menu-wheelchair-icons" alt="Wheelchair accessible icon">
                                    <div class="label-severity-axis-label">Passable</div>
                                </div>
                                <div class="radio-inline" id="severity-one" data-toggle="tooltip" onmouseut="function(){}">
                                    <label class="radio-button-labels">
                                        <input type="radio" name="label-severity" value="1">
                                            <img src='/assets/javascripts/SVLabel/img/misc/SmileyRating_1_BW.png'
                                            default-src='/assets/javascripts/SVLabel/img/misc/SmileyRating_1_BW.png'
                                            value="1" alt="Smiley face rating 1">
                                        <div>1</div>
                                    </label>
                                </div>
                                <div class="radio-inline" id="severity-two">
                                    <label class="radio-button-labels">
                                        <input type="radio" name="label-severity" value="2">
                                        <img src='/assets/javascripts/SVLabel/img/misc/SmileyRating_2_BW.png'
                                            default-src='/assets/javascripts/SVLabel/img/misc/SmileyRating_2_BW.png'
                                            value="2" alt="Smiley face rating 2">
                                        <div>2</div>
                                    </label>
                                </div>
                                <div class="radio-inline" id="severity-three" data-toggle="tooltip">
                                  <label class="radio-button-labels">
                                      <input type="radio" name="label-severity" value="3">
                                        <img src='/assets/javascripts/SVLabel/img/misc/SmileyRating_3_BW.png'
                                            default-src='/assets/javascripts/SVLabel/img/misc/SmileyRating_3_BW.png'
                                            value="3" alt="Smiley face rating 3">
                                        <div>3</div>
                                    </label>
                                </div>
                                <div class="radio-inline" id="severity-four">
                                    <label class="radio-button-labels">
                                        <input type="radio" name="label-severity" value="4">
                                        <img src='/assets/javascripts/SVLabel/img/misc/SmileyRating_4_BW.png'
                                            default-src='/assets/javascripts/SVLabel/img/misc/SmileyRating_4_BW.png'
                                            value="4" alt="Smiley face rating 4">
                                        <div>4</div>
                                    </label>
                                </div>
                                <div class="radio-inline" id="severity-five" data-toggle="tooltip">
                                  <label class="radio-button-labels">
                                      <input type="radio" name="label-severity" value="5">
                                        <img src='/assets/javascripts/SVLabel/img/misc/SmileyRating_5_BW.png'
                                            default-src='/assets/javascripts/SVLabel/img/misc/SmileyRating_5_BW.png'
                                            value="5" alt="Smiley face rating 5">
                                        <div>5</div>
                                    </label>
                                </div>
                                <div class="radio-inline" id="column-not-passable">
                                    <img src='@routes.Assets.at("javascripts/SVLabel/img/icons/WheelchairInaccessible-2.png")'
                                        class="context-menu-wheelchair-icons" alt="Wheelchair inaccessible icon">
                                    <div class="label-severity-axis-label">Not Passable</div>
                                </div>
                            </div>
                        </div>
                        <div id="problem-property-menu">
                            <div>
                                <input type="text" class="form-control" placeholder="Description" id="context-menu-problem-description-text-box">
                            </div>
                            <div class="add-tags-label">Add Tags:</div>
                            <div id="context-menu-tag-holder">
                                <button class="context-menu-tag" name='tag' id="0"></button>
                                <button class="context-menu-tag" name='tag' id="1"></button>
                                <button class="context-menu-tag" name='tag' id="2"></button>
                                <button class="context-menu-tag" name='tag' id="3"></button>
                                <button class="context-menu-tag" name='tag' id="4"></button>
                                <button class="context-menu-tag" name='tag' id="5"></button>
                                <button class="context-menu-tag" name='tag' id="6"></button>
                                <button class="context-menu-tag" name='tag' id="7"></button>
                                <button class="context-menu-tag" name='tag' id="8"></button>
                                <button class="context-menu-tag" name='tag' id="9"></button>
                            </div>
                            <div class="checkbox-inline" id="context-menu-temporary-problem-checkbox-holder">
                                <label><input type="checkbox" style= "cursor: pointer;" id="context-menu-temporary-problem-checkbox" value="temporary-problem">Temporary (e.g., construction, trash)</label>
                                <button id="context-menu-ok-button">OK</button>
                            </div>
                        </div>
                    </div>
                    <div id="context-menu-vertical-connector"></div>
                </div>
            </div>
            <div id="google-maps-holder">
                <div id="google-maps" class="google-maps-pane"></div>
                <div id="google-maps-overlay" class="google-maps-pane">Follow the red line</div>
            </div>
            <div id="compass-holder" class="">
                <div id="compass-message-holder" class="animated white-background-75">
                    <span id="compass-message"></span>
                    <div id="compass-message-connector"></div>
                </div>
            </div>
            <div id="page-overlay-holder">
                <!--<img src='@routes.Assets.at("javascripts/SVLabel/img/misc/AjaxLoader.gif")' id="ajax-loader-image">-->
            </div>
            <div id="pop-up-message-holder" class="hidden">
                <div id="pop-up-message-background"></div>
                <div id="pop-up-message-foreground">
                    <h2 id="pop-up-message-title" class="bold">Title</h2>
                    <p id="pop-up-message-content">Content</p>
                    <div id="pop-up-message-img-holder"></div>
                    <div id="pop-up-message-button-holder"></div>
                </div>
            </div>
            <div id="modal-skip-holder" class="hidden">
                <div id="modal-skip-background"></div>
                <div id="modal-skip-box">
                    <div id="modal-skip-box-new-location"></div>
                    <div id="modal-skip-box-new-neighborhood"></div>
                    <div id="modal-skip-title" class="bold">
                        <p>Jump to another location because:</p>
                    </div>
                    <div id="modal-skip-box-content">
                        <input type="button" class="overlay-option" id="modal-skip-explore" value="I want to explore another area!">
                        <input type="button" class="overlay-option" id="modal-skip-unavailable" value="I cannot go the direction you want me to walk.">
                    </div>
                    <div class="modal-skip-cancel-button">
                        <button class="button" id="modal-skip-cancel-first-button">Cancel</button>
                    </div>
                </div>
                <div id="modal-skip-box-neighborhood">
                    <div id="modal-skip-neighborhood-title" class="bold">
                        <p>Go to a new location or a new neighborhood?</p>
                    </div>
                    <div id="modal-skip-neighborhood-content">
                        <input type="button" class="overlay-option" id="modal-skip-continue-neighborhood" value="Go to a new location in this neighborhood">
                        <input type="button" class="overlay-option" id="modal-skip-redirect-jump" value="Go to a new neighborhood">
                    </div>
                    <div class="modal-skip-cancel-button">
                        <button class="button" id="modal-skip-cancel-second-button">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="modal-comment-holder" class="hidden">
                <div id="modal-comment-background"></div>
                <div id="modal-comment-box">
                    <form id="comment-form">
                        <div id="modal-comment-title" class="bold">
                            <p>
                                Any thoughts? Found something confusing? Spotted a bug? <br />
                                Send us comments!
                            </p>
                        </div>
                        <div id="modal-comment-content">
                            <textarea id="modal-comment-textarea" placeholder=""></textarea>
                        </div>
                        <div>
                            <button class="button" id="modal-comment-ok-button">OK</button>&nbsp;
                            <button class="button" id="modal-comment-cancel-button">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="modal-mission-holder">
                <div id="modal-mission-background" class="modal-background"></div>
                <div id="modal-mission-foreground" class="modal-foreground">
                    <h1 id="modal-mission-header" class="text-center">Mission</h1>
                    @if(user) {
                        @if(user.get.role.getOrElse("") == "Turker") {
                            <h4 id="modal-mission-reward-text" class="text-center" style="display: none"></h4>
                        }
                    }
                    <div id="modal-mission-instruction"></div>
                    <button class="button" id="modal-mission-close-button">OK</button>
                </div>
            </div>
            <div id="modal-mission-complete-holder">
                <div id="modal-mission-complete-background" class="modal-background"></div>
                <div id="modal-mission-complete-foreground" class="modal-foreground">
                    <h1><span class="normal" id="modal-mission-complete-title"></span></h1>
                    <div class="row">
                        <div class="mapbox col-sm-7">
                            <div id="modal-mission-complete-map">
                            </div>
                            <div id="map-legend">
                                <span><svg class="legend-label" width="15" height="10"><rect width="15" height="10" id="green-square"></rect></svg> This Mission</span><br>
                                <span><svg class="legend-label" width="15" height="10"><rect width="15" height="10" id="blue-square"></rect></svg> Previous Missions</span><br>
                                <span><svg class="legend-label" width="15" height="10"><rect width="15" height="10" id="gray-square"></rect></svg> Other Users' Missions</span>
                            </div>

                        </div>
                        <div class="col-sm-5">
                            <p><span id="modal-mission-complete-message"></span></p>
                            <h3>Mission Labels</h3>
                            <table class="table">
                                <tr>
                                    <th class="width-50-percent">Curb Ramp</th>
                                    <td id="modal-mission-complete-curb-ramp-count" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>Missing Curb Ramp</th>
                                    <td id="modal-mission-complete-no-curb-ramp-count" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>Obstacle in Path</th>
                                    <td id="modal-mission-complete-obstacle-count" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>Surface Problem</th>
                                    <td id="modal-mission-complete-surface-problem-count" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>No Sidewalk</th>
                                    <td id="modal-mission-complete-no-sidewalk-count" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>Other</th>
                                    <td id="modal-mission-complete-other-count" class="col-right"></td>
                                </tr>
                            </table>
                            <h3>Neighborhood Progress</h3>
                            <div id="modal-mission-complete-complete-bar"></div>
                            <table class="table">
                                @if(user){
                                    @if(user.get.role.getOrElse("") == "Turker") {
                                        <tr>
                                            <th>Earned in this mission</th>
                                            <td id="modal-mission-complete-mission-reward" class="col-right" style="color: forestgreen;"></td>
                                        </tr>
                                    }
                                }
                                <tr>
                                    <th>You audited in this mission</th>
                                    <td id="modal-mission-complete-mission-distance" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>You audited in this neighborhood</th>
                                    <td id="modal-mission-complete-total-audited-distance" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>Others audited in this neighborhood</th>
                                    <td id="modal-mission-complete-others-distance" class="col-right"></td>
                                </tr>
                                <tr>
                                    <th>Remaining in this neighborhood</th>
                                    <td id="modal-mission-complete-remaining-distance" class="col-right"></td>
                                </tr>
                            </table>
                            @if(user){
                                @if(user.get.role.getOrElse("") == "Turker" && !MissionTable.hasCompletedAuditMissionInThisAmtAssignment(user.get.username)) {
                                    <button class="btn blue-btn" id="modal-mission-complete-generate-confirmation-button">Click to generate HIT confirmation code</button>
                                }
                            }
                            <button class="btn btn-primary" id="modal-mission-complete-close-button-primary"></button>
                            <button class="btn btn-secondary" id="modal-mission-complete-close-button-secondary"></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-curb-ramp-example" class="hidden">
                <div class="modal-background"></div>
                <div class="modal-foreground" id="modal-curb-ramp-foreground">
                    <div class="row">
                        <div class="col-md-12">
                            <h1 class="text-center bold">Curb Ramp</h1>
                        </div>
                        <div class="modal-close-button-holder">
                            <button type="button" class="close modal-example-close-buttons" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/CurbRamp_Passable.png")' class="img-responsive" alt="Two good curb ramps" />
                            <p class="bold">Rating 1: Passable</p>
                            <p>Clean curb ramps that are aligned with crosswalks.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/CurbRamp_HardToPass.png")' class="img-responsive" alt="Water has accumulated in the curb ramp" />
                            <p class="bold">Rating 3: Neutral</p>
                            <p>A curb ramp with a pole standing in the middle. People who use large electrical wheelchairs
                                may have trouble using this curb ramp.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/CurbRamp_NotPassable.png")' class="img-responsive" alt="Water has accumulated in the curb ramp" />
                            <p class="bold">Rating 5: Not passable</p>
                            <p>Water has accumulated in this curb ramp due to poor drainage. It is hard for manual wheelchair users to use this curb ramp.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-no-curb-ramp-example" class="hidden">
                <div class="modal-background"></div>
                <div class="modal-foreground" id="modal-no-curb-ramp-foreground">
                    <div class="row">
                        <div class="col-md-12">
                            <h1 class="text-center bold">No Curb Ramp</h1>
                        </div>
                        <div class="modal-close-button-holder">
                            <button type="button" class="close modal-example-close-buttons" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/NoCurbRamp_Passable.png")' class="img-responsive" alt="Curb ramp is not aligned to the crosswalk" />
                            <p class="bold">Rating 1: Passable</p>
                            <p>Although there is no curb ramp, the level difference is small and
                                wheelchair users would be able to get on or off the sidewalk.
                                There is also a curb ramp at the same corner that people could use,
                                although it is not aligned to the path.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/NoCurbRamp_HardToPass.png")' class="img-responsive" alt="No curb ramp at the end of the crosswalk" />
                            <p class="bold">Rating 3: Neutral</p>
                            <p>There is no curb ramp at the end of the crosswalk.
                                Wheelchair users are forced to used the curb ramp that is not aligned with the crosswalk.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/NoCurbRamp_NotPassable.png")' class="img-responsive" alt="No curb ramp at the end of the crosswalk" />
                            <p class="bold">Rating 5: Not passable</p>
                            <p>No curb ramp at the end of the crosswalk. Wheelchair users cannot get on or off the sidewalk and cross the street here.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-obstacle-example" class="hidden">
                <div class="modal-background"></div>
                <div class="modal-foreground" id="modal-obstacle-foreground">
                    <div class="row">
                        <div class="col-md-12">
                            <h1 class="text-center bold">Obstacle</h1>
                        </div>
                        <div class="modal-close-button-holder">
                            <button type="button" class="close modal-example-close-buttons" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/Obstacle_Passable.png")' class="img-responsive" alt="Overgrown bush is partly blocking the path." />
                            <p class="bold">Rating 1: Passable</p>
                            <p>A traffic light standing in the middle of the sidewalk. There seems to be enough space
                            for wheelchair users to pass, but those who are using larger chairs
                            could have trouble navigating.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/Obstacle_HardToPass.png")' class="img-responsive" alt="Overgrown bush is partly blocking the path." />
                            <p class="bold">Rating 3: Neutral</p>
                            <p>The plant is obstructing the path, making it hard for wheelchair users to use this sidewalk.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/Obstacle_NotPassable.png")' class="img-responsive" alt="A tree is completely blocking the path." />
                            <p class="bold">Rating 5: Not passable</p>
                            <p>The tree is completely blocking the path, making it not passable for wheelchair users.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-surface-problem-example" class="hidden">
                <div class="modal-background"></div>
                <div class="modal-foreground" id="modal-surface-problem-foreground">
                    <div class="row">
                        <div class="col-md-12">
                            <h1 class="text-center bold">Surface Problem</h1>
                        </div>
                        <div class="modal-close-button-holder">
                            <button type="button" class="close modal-example-close-buttons" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/SurfaceProblem_Passable.png")' class="img-responsive" alt="A partially damaged sidewalk." />
                            <p class="bold">Rating 1: Passable</p>
                            <p>Partially damaged sidewalk. Because there is enough space next to the damaged part of
                            the sidewalk, wheelchair users would be able to pass. </p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/SurfaceProblem_HardToPass.png")' class="img-responsive" alt="Cobblestone sidewalks and crosswalks." />
                            <p class="bold">Rating 3: Neutral</p>
                            <p>Wheelchair users would have difficulty navigating on the cobblestone
                                sidewalks and crosswalks.</p>
                        </div>
                        <div class="col-md-4">
                            <img src='@routes.Assets.at("javascripts/SVLabel/img/examples/SurfaceProblem_NotPassable.png")' class="img-responsive" alt="A tree is completely blocking the path." />
                            <p class="bold">Rating 5: Not passable</p>
                            <p>Wheelchair users cannot pass severely degraded sidewalk surfaces
                                due to the over-grown vegetation.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="annotation-holder"></div>

            <div id="task-completion-message-holder">
                <img src='@routes.Assets.at("javascripts/SVLabel/img/misc/GoodJob.png")' alt="Task completion message: Good Job!" />
            </div>
            <div id='tracker-holder'>
                <ul id='tracked-items-holder'></ul>
            </div>
        </div>
    </div>

    <template class="onboarding" val="initial-instruction" id="onboarding-initial-instruction">
        <div class="row">
            <div class="col-md-12">
                <p>
                    In <span class="bold">Project Sidewalk,</span> youâ€™ll virtually travel through cities completing
                        missions to find and label accessibility features and problems in the environment, including:
                </p>
                <p>
                    <img src='@routes.Assets.at("javascripts/SVLabel/img/onboarding/ExamplePictures03_v2.png")' id="onboarding-example-image-1"
                    alt="Examples of accessibility attributes: curb ramps, missing curb ramps, obstacles in path, and surface problems.">
                </p>

            </div>
            <div class="col-md-6">
                <p>
                    <span class="bold">Weâ€™ll begin with a short, interactive tutorial.</span>
                </p>
            </div>
            <div class="col-md-offset-3 col-md-3">
                <p>
                    <button class="button onboarding-transition-trigger" id="onboarding-ok-button" value="OK" style="position: relative; top: -4px;">Let's get started!</button>
                </p>
            </div>

                <div class="col-md-12" id="onboarding-skip-option">
                    <p class="text-right"><span style='font-size: 65%;'>
                        Already taken the tutorial? Have an account?
                        <a href="#SignIn" data-toggle="modal" data-target="#sign-in-modal-container">&nbsp;Sign in</a>
                        now
                        or <a value="Skip" class="onboarding-transition-trigger">skip the tutorial.</a>
                    </span></p>
                </div>

            <script>
                    var role = '@user.get.role';
                    var numMissionsCompleted = svl.missionContainer.getCompletedMissions().length;
                    if (role === 'Turker' && numMissionsCompleted === 0) {
                        $("#onboarding-skip-option").hide();
                    } else{
                        $("#onboarding-skip-option").show();
                    }
            </script>

        </div>
    </template>
    <template class="onboarding" val="outro" id="onboarding-outro">
        <div class="row">
            <div class="col-md-12">
                <p>
                    Great! Youâ€™ve learned how to use the interface! Now, go ahead and
                    <span class="bold">label the following accessibility attributes in Google Street View</span> that
                        significantly affect how wheelchair users move about the city:
                </p>
                <p>
                    <img src='@routes.Assets.at("javascripts/SVLabel/img/onboarding/ExamplePictures02.png")' id="onboarding-example-image-2"
                    alt="Examples of accessibility attributes: curb ramps, missing curb ramps, obstacles in path, and surface problems.">
                </p>
                <p>
                    Again, thank you for <span class="bold">making the world more accessible for everyone!</span>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10"></div>
            <div class="col-md-2">
                <button class="button" id="onboarding-ok-button">OK</button>
            </div>
        </div>
    </template>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/lib/turf.min.js")'></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />


    <script type="text/javascript">
        // Todo. Try to move the following code to Main.js
        var svl = svl || {};
        var mainParam = {};
        svl.storage = new TemporaryStorage(JSON);
        if (!("tracker" in svl)) {
            svl.tracker = new Tracker();
        }

        svl.userModel = new UserModel();
        @if(user) {
            var userParam = {
                username: '@user.get.username',
                role: '@user.get.role'
            };
            svl.user = new User(userParam);

            $('#status-holder-neighborhood-name').parent().wrap('<a href="" target="_blank" id="status-neighborhood-link"></a>');
        } else {
            $('#status-neighborhood-link').hide();

            var userParam = {
                username: "anonymous",
                role: "Anonymous"
            };
            svl.user = new User(userParam);
        }
        svl.userModel._user = svl.user;
        var hitExpired = false;
        @if(user && user.get.role.getOrElse("") == "Turker") {
            var msRemaining = @AMTAssignmentTable.getMsLeftOnMostRecentAsmt(user.get.username);
            if (msRemaining < 0) {
                hitExpired = true;
            }
        }
        if(hitExpired) {
            $(".toolUI").css({"visibility": "visible"});
            $('#HIT-expiration-overlay').show();
        } else @if(task) {
            var streetViewService = new google.maps.StreetViewService();
            svl.streetViewService = streetViewService;
            var STREETVIEW_MAX_DISTANCE = 25;

            var geojson = @Html(task.get.toJSON.toString);
            var lat1 = geojson.features[0].properties.current_lat;
            var lng1 = geojson.features[0].properties.current_lng;
            var startPointReversed = geojson.features[0].properties.start_point_reversed;
            var latLng = new google.maps.LatLng(lat1, lng1);

            if (!("navigationModel" in svl)) svl.navigationModel = new NavigationModel();
            if (!("neighborhoodModel" in svl)) svl.neighborhoodModel = new NeighborhoodModel();
            svl.taskModel = new TaskModel();
            svl.taskFactory = new TaskFactory(svl.taskModel);
            svl.taskContainer = new TaskContainer(svl.navigationModel, svl.neighborhoodModel, streetViewService, svl, svl.taskModel, svl.tracker);

            // Todo. Issue #43 Here, we may want to check if there is a previous task that is cached in user's browser.
            streetViewService.getPanorama({location: latLng, radius: STREETVIEW_MAX_DISTANCE, source: google.maps.StreetViewSource.OUTDOOR}, function (streetViewPanoramaData, status) {
                if (status === google.maps.StreetViewStatus.OK) {
                    // Ok
                    var tutorialTask = geojson.features[0].properties.street_edge_id === @tutorialStreetId
                    var newTask = svl.taskFactory.create(geojson, tutorialTask, lat1, lng1, startPointReversed);
                    svl.taskContainer.setCurrentTask(newTask);
                    init();

                    // Handle query strings for panoId or latLng (panoId, lat, lng only Some[] when user is Admin)
                    @if(panoId) {
                        try {
                            svl.streetViewService.getPanorama({pano: "@panoId.get"}, function(panoData){
                                var lat = panoData.location.latLng.lat();
                                var lng = panoData.location.latLng.lng();
                                svl.map.setPositionByIdAndLatLng("@panoId.get", lat, lng);
                            });
                        } catch (e) {
                            console.error("Invalid panorama ID");
                        }                        
                    } else { @if(lat && lng) {
                        svl.map.setPosition(@lat.get, @lng.get);
                    }}
                }
                else {
                    // No street view available in this range.
                    console.error("Error loading Street View imagery: " + status);
                    console.log("Street edge we are trying to audit: " + @task.map(_.edgeId).getOrElse(-1));
                }
            });
        } else {
            $(".toolUI").css({"visibility": "visible"});
            $('#already-completed-neighborhood-overlay').show();
        }

        $(document).ready(function(){
            // Solutions to annoying text selection cursor.
            // http://forum.jquery.com/topic/chrome-text-select-cursor-on-drag
            document.onselectstart = function () { return false; };
            enableTouchSupport();

            // Advanced Neighborhood Overlay
            $('#continue-advanced').on('click', function(){
                mainParam.advancedOverlay = false;
                $('#advanced-overlay').hide();
            });

            $('#redirect-advanced').on('click', function(){
                mainParam.advancedOverlay = false;
                $(location).attr('href', '/audit?nextRegion=easy');
            });

            // Neighborhood Completion Overlay
            $('#continue-current').on('click', function(){
                $('#neighborhood-completion-overlay').hide();
            });

            $('#redirect-new').on('click', function(){
                $(location).attr('href', '/audit?nextRegion=regular');
            });

            // Already Completed Neighborhood Overlay
            $('#accept-redirect').on('click', function(){
                $(location).attr('href', '/audit');
            });

            @* If this is a CV ground truth audit, initialize a CVGroundTruthMission object. If mission is null,
             the create ground truth mission form will be displayed, otherwise the ground truth audit will start. *@
            @if(enableCVGroundTruthLabelingMode) {
                svl.cvGroundTruthMission = new CVGroundTruthMission(@Html(mission.toJSON.toString));
            }

        });

        function enableTouchSupport() {
            $(document).on('touchstart touchmove touchend touchcancel', function(e) {
                var event = e.originalEvent;
                var touches = event.changedTouches,
                        first = touches[0],
                        type = "";

                switch(event.type) {
                    case "touchstart": type = "mousedown"; break;
                    case "touchmove":  type = "mousemove"; break;
                    case "touchend":   type = "mouseup";   break;
                    default:           return;
                }

                var simulatedEvent = new MouseEvent(type, {
                    screenX: first.screenX,
                    screenY: first.screenY,
                    clientX: first.clientX,
                    clientY: first.clientY
                });

                first.target.dispatchEvent(simulatedEvent);
            });

            $("#interaction-area-holder").on("touchmove", function (event) {
                event.preventDefault();
            });
        }

        function init() {
            var mainParam = mainParam || {},
                    formParam = {},
                    initialLocation = svl.taskContainer.getCurrentTask().getCurrentLatLng();
            formParam.dataStoreUrl = '@routes.TaskController.post';
            formParam.beaconDataStoreUrl = formParam.dataStoreUrl + "Beacon";
            formParam.hitId = '';
            formParam.assignmentId = '';
            formParam.turkerId = '';
            formParam.onboarding = false;
            formParam.taskPanoramaId = "";
            formParam.taskDescription = "";
            formParam.domIds = {};
            formParam.domIds.canvas = 'onboardingCanvas';
            mainParam.form = formParam;
            mainParam.initLat = initialLocation.lat;
            mainParam.initLng = initialLocation.lng;
            mainParam.rootDirectory = "/assets/javascripts/SVLabel/";
            @if(user){
                @if(user.get.role.getOrElse("") == "Turker") {
                    svl.assignmentId = "@AMTAssignmentTable.getMostRecentAssignmentId(user.get.username)";
                    svl.amtAssignmentId = @AMTAssignmentTable.getMostRecentAMTAssignmentId(user.get.username);
                    svl.confirmationCode = "@AMTAssignmentTable.getConfirmationCode(user.get.username,AMTAssignmentTable.getMostRecentAssignmentId(user.get.username))";
                    @if(!MissionTable.hasCompletedAuditMissionInThisAmtAssignment(user.get.username)){
                        $("#left-column-confirmation-code-button").css('visibility', "hidden");
                    } else{
                        $("#left-column-confirmation-code-button").css('visibility', "");
                        $("#left-column-confirmation-code-button").attr('data-toggle','popover');
                        $("#left-column-confirmation-code-button").attr('title','Submit this code for HIT verification on Amazon Mechanical Turk');
                        $("#left-column-confirmation-code-button").attr('data-content',svl.confirmationCode);
                        $("#left-column-confirmation-code-button").popover();

                        //Hide the confirmation popover on clicking the background
                        //https://stackoverflow.com/questions/11703093/how-to-dismiss-a-twitter-bootstrap-popover-by-clicking-outside

                        $(document).on('click', function (e) {
                            $("#left-column-confirmation-code-button").each(function () {
                                //the 'is' for buttons that trigger popups
                                //the 'has' for icons within a button that triggers a popup
                                if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                                    (($(this).popover('hide').data('bs.popover')||{}).inState||{}).click = false
                                }

                            });
                        });
                    }
                    $("#current-mission-reward").show();
                    $("#total-mission-reward").show();
                    $("#modal-mission-reward-text").show();
                } else{
                    $("#left-column-confirmation-code-button").css('visibility', "hidden");
                }
            } else{
                $("#left-column-confirmation-code-button").css('visibility', "hidden");
            }
            var missionDescriptionParam = {};
            missionDescriptionParam.description = "";
            mainParam.missionDescription = missionDescriptionParam;

            mainParam.regionId = @region.regionId;
            mainParam.regionName = '@region.name';
            mainParam.regionLayer = omnivore.wkt.parse("@region.geom");
            if(@RegionTable.difficultRegionIds.contains(region.regionId)){
                   $('#advanced-overlay').show();
                   mainParam.advancedOverlay = true
            }

            mainParam.nextTemporaryLabelId = @nextTempLabelId;
            mainParam.mission = @Html(mission.toJSON.toString);
            mainParam.tutorialStreetId = @tutorialStreetId;
            mainParam.missionSetProgress = @missionSetProgress;
            mainParam.hasCompletedAMission = @hasCompletedMission;

            svl.main = new Main(mainParam);
        }

        @if(user){
        //Survey Submission
        $("#surveyForm").submit(function submitSurvey(e) {
            var formData = $('#surveyForm').serializeArray();
            //alert(formData);

            var surveyUrl = '/survey';
            var async = true;
            //submit data from survey
            $.ajax({
                async: async,
                contentType: 'application/json; charset=utf-8',
                url: surveyUrl,
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(formData),
                success: function (data) {
                    //close survey modal here
                    $('#survey-modal-container').modal('hide');
                }
            });
            // Prevents reloading the audit page with the posted data in the url
            // https://stackoverflow.com/questions/12624230/jquery-post-returns-querystring-in-address-bar
            e.preventDefault();
        });
        }

    </script>

<!-- now we will start the logging behaviour -->
<script>

    // Log whether the survey was skipped or completed to WebpageActivityTable
    // Log is of form: "SurveySkip"
    $('#survey-skip-button').on('click', function(){
        var activity = "SurveySkip";
        var url = "/userapi/logWebpageActivity";
        var async = true;
        $.ajax({
            async: async,
            contentType: 'application/json; charset=utf-8',
            url: url,
            type: 'post',
            data: JSON.stringify(activity),
            dataType: 'json',
            success: function(result){},
            error: function (result) {
                console.error(result);
            }
        });
    });
    </script>
}
