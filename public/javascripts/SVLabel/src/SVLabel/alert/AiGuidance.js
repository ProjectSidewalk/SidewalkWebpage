/**
 * Module for displaying AI guidance messages to the user at the start of a task.
 *
 * @param tracker
 * @param popUpMessage
 * @returns {{className: string}}
 * @constructor
 */
function AiGuidance(tracker, popUpMessage) {
    var self = this;

    /**
     * Analyzes the current street using Gemini AI and returns guidance for the user.
     * @returns {Promise<null|AuthenticatorResponse|any>}
     * @private
     */
    async function _analyzeCurrentStreetWithGemini(currTask) {
        try {
            // Prepare the request payload.
            const payload = {
                way_type: currTask.getProperty('wayType'),
                street_edge_id: currTask.getProperty('streetEdgeId')
            };

            // Send request to the backend.
            const response = await fetch('/ai/analyzeScene', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                return result.response;
            } else {
                console.error('Analysis failed:', result.error);
                throw new Error(result.error);
            }

        } catch (error) {
            console.error('Error analyzing canvas:', error);
            throw error;
        }
    }

    /**
     * Displays a pop-up message with AI-generated guidance based on the current street. Pilot in Chandigarh, India.
     */
    function showAiGuidanceMessage() {
        if (svl.cityId === 'chandigarh-india') {
            _analyzeCurrentStreetWithGemini(svl.taskContainer.getCurrentTask())
                .then(response => {
                    const title = 'Mission Guidance';
                    const body = `<span>${response}  <span title="This was generated by AI using imagery from this street." style="cursor: pointer">&#9432;</span></span>`;

                    // Show the pop-up message with the AI guidance.
                    popUpMessage.notify(title, body, function () {
                        // Log the message shown to the user.
                        tracker.push('PopUpShow_AiGuidance', {message: response});
                    });

                    // Add the AI guidance just above the minimap, with full text on hover in case it's too long to fit.
                    $('#mission-guidance-status').text(response);
                    $('#mission-guidance-status').attr('data-full-text', response);
                })
                .catch(error => {
                    tracker.push('PopUpShow_AiGuidance_Error', {error: error.message});
                    console.error('Error showing AI guidance:', error);
                });
        }
    }

    self.showAiGuidanceMessage = showAiGuidanceMessage;
}
